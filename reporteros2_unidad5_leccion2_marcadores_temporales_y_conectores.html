<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reporteros 2 ‚Ä¢ Unidad 5 ‚Ä¢ Lecci√≥n 2 ‚Äî Los marcadores temporales y conectores (v1)</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@700&family=Pacifico&family=Roboto+Slab:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --paper:#fff8e1; --terracotta:#d93223; --mustard:#ffb841; --navy:#2c3c80;
    --olive:#41845f; --ink:#3d3d3d; --shadow:rgba(0,0,0,.15);
  }
  html,body{margin:0;padding:0;background:var(--paper);color:var(--ink);font-family:"Roboto Slab", Georgia, serif;}
  .wrap{max-width:960px;margin:0 auto;padding:16px 18px 80px;}
  .airmail{height:12px;background:repeating-linear-gradient(45deg, #d93223 0 16px,#ffb841 16px 32px,#2c3c80 32px 48px);}
  header{
    background:linear-gradient(#fff8e1,#fbecc3);border:2px solid rgba(0,0,0,.08);
    border-radius:14px;box-shadow:0 4px 14px var(--shadow);margin-top:12px;padding:14px;
  }
  .head-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap;}
  .stamp{width:72px;height:72px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #b23b2f 0 25%, #8a2a21 26% 100%);box-shadow:inset 0 0 0 6px rgba(0,0,0,.15), 0 4px 8px var(--shadow);position:relative;}
  .stamp:after{content:"‚úàÔ∏è";position:absolute;inset:0;display:grid;place-items:center;font-size:30px;color:#f5e2df;filter:drop-shadow(0 1px 0 rgba(0,0,0,.25));}
  .title{flex:1;min-width:220px;font-family:"Montserrat Alternates", Arial, sans-serif;font-weight:700;font-size:1.35rem; line-height:1.2;padding:10px 14px;background:#fff;border:2px solid rgba(0,0,0,.08);border-radius:10px;box-shadow:0 4px 10px var(--shadow);}
  .namefields{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .namefields label{font-size:.85rem;}
  .nf{border:1.5px dashed #bfa06b;background:#fff; padding:6px 8px;border-radius:8px;min-width:120px;}
  .route{margin-top:10px;border-top:1px dashed rgba(0,0,0,.2);padding-top:12px;}
  .route-line{position:relative;height:16px;background:#e9dfc6;border-radius:999px;overflow:hidden; box-shadow:inset 0 1px 2px rgba(0,0,0,.25)}
  .route-fill{position:absolute;inset:0; width:0%; background:linear-gradient(90deg, #ffb841 0%, #ffd87a 100%); transition:width .4s;}
  .pinrow{display:flex;justify-content:space-between;margin-top:6px;}
  .pin{width:26px;height:26px;border-radius:50%;background:#ccc;border:2px solid #777; display:grid;place-items:center;font-size:.8rem;box-shadow:0 2px 4px var(--shadow);}
  .pin.done{background:#4caf50;border-color:#2e7d32;color:#fff;}

  .section{background:#fff;border:1.5px solid rgba(0,0,0,.08);border-radius:14px;box-shadow:0 6px 14px var(--shadow);padding:16px;margin:18px 0;position:relative;}
  h2,h3{font-family:"Montserrat Alternates", Arial, sans-serif;margin:6px 0 8px}
  h2{font-size:1.25rem}
  details summary{font-weight:600;cursor:pointer;user-select:none}

  .stopprog{display:flex;align-items:center;gap:10px;margin:8px 0 6px}
  .mini-prog{flex:1;height:12px;background:#e9dfc6;border-radius:8px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.25)}
  .mini-fill{height:100%;width:0%;background:linear-gradient(90deg,#ffb841,#ffd87a);transition:width .4s}
  .mini-fill.meets{background:linear-gradient(90deg,#4caf50,#81c784)}
  .mini-txt{font-size:.9rem;color:#3d3d3d;min-width:185px;text-align:right}

  /* Parada 1 */
  .p1-row{display:grid;grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));gap:12px;padding:8px 4px;overflow-x:hidden;}
  .target{background:#fbf1d3;border:2px dashed #c5b28b;border-radius:12px;padding:10px;position:relative;transition:transform .15s;}
  .target:hover{transform:translateY(-2px)}
  .target .icon{font-size:22px;margin-right:6px}
  .drop-here{font-size:.9rem;opacity:.7;margin-top:8px}
  .spanish-chip{display:inline-flex;align-items:center;gap:8px;background:#fff;border:2px solid #bfa06b;border-radius:999px;padding:8px 12px;margin:10px 0;cursor:grab;box-shadow:0 2px 6px var(--shadow);font-weight:600;}
  .correct{outline:3px solid #4caf50}
  .wrong{animation:shake .28s linear}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}

  /* Parada 2 */
  .clue{font-family:"Roboto Slab", serif;background:#fff8e6;border-left:6px solid var(--olive);padding:10px;border-radius:8px}
  .p2-options{display:grid;grid-template-columns:1fr 1fr; gap:10px;margin-top:10px}
  .btn{border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;box-shadow:0 2px 6px var(--shadow);}
  .btn.navy{background:var(--navy);color:#fff}
  .btn.olive{background:var(--olive);color:#fff}
  .btn.ghost{background:#fff;border:2px solid #bfa06b}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Parada 3 */
  .grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));gap:10px;}
  .grid.locked{pointer-events:none;opacity:.7;filter:saturate(.8);}
  .card{position:relative;height:110px;perspective:800px;cursor:pointer}
  .face{position:absolute;inset:0;background:#fff;border-radius:12px;border:2px solid rgba(0,0,0,.08);display:grid;place-items:center;backface-visibility:hidden;transition:transform .4s;box-shadow:0 2px 8px var(--shadow);padding:8px;text-align:center;}
  .front{transform:rotateY(180deg)}
  .back{transform:rotateY(0deg)}
  .card.flipped .front{transform:rotateY(0deg)}
  .card.flipped .back{transform:rotateY(-180deg)}
  .flag{position:relative;width:88%;height:70%;border:2px solid #333;border-radius:6px;background:linear-gradient(#75aadb 0 33%,#fff 33% 66%,#75aadb 66%)}
  .flag .sun{position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);width:26px;height:26px;border-radius:50%;background:#f1b400;box-shadow:0 0 0 2px rgba(0,0,0,.2)}

  .p3-banner{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,248,225,.92);backdrop-filter:blur(2px);border-radius:12px;}
  .p3-banner.show{display:flex;}
  .p3-card{background:#fff;border:2px dashed #bfa06b;border-radius:14px;box-shadow:0 8px 18px var(--shadow);padding:18px 20px;text-align:center;max-width:520px;}
  .p3-card h3{margin:6px 0 6px;font-family:"Montserrat Alternates", Arial, sans-serif}
  .p3-card p{margin:6px 0 8px}
  .p3-card .btn{margin-top:8px}

  /* Parada 4 */
  .dropzone{min-height:64px;border:2px dashed #bfa06b;background:#fff;border-radius:12px;padding:10px;display:flex;flex-wrap:wrap;gap:8px}
  .bank{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{background:#fff;border:2px solid #bfa06b;border-radius:999px;padding:6px 10px;cursor:grab;box-shadow:0 2px 6px var(--shadow);}
  .p4-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .hint{font-size:.95rem;opacity:.8;margin-top:6px}

  /* Parada 5 */
  .radio{background:#222;color:#fff;border-radius:16px;padding:14px;display:flex;align-items:center;gap:14px;box-shadow:0 6px 14px rgba(0,0,0,.4)}
  .record{width:72px;height:72px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #666 0 30%, #111 31% 100%);display:grid;place-items:center;animation:spin 6s linear infinite paused}
  .record.playing{animation-play-state:running}
  @keyframes spin{to{transform:rotate(360deg)}}

  footer{margin-top:22px;display:flex;gap:16px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap}
  .postcard{background:#fff;border:2px solid rgba(0,0,0,.08);border-radius:12px;box-shadow:0 6px 14px var(--shadow);padding:12px;min-width:260px;}

  .voice-pill{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:#fff;border:2px dashed #bfa06b;border-radius:999px;padding:8px 12px;margin-top:10px}
  .voice-pill select,.voice-pill input[type="range"]{accent-color:#41845f}
  .voice-label{font-size:.85rem;opacity:.8}
</style>
</head>
<body>
<div class="airmail"></div>
<div class="wrap">
  <header>
    <div class="head-row">
      <div class="stamp" aria-hidden="true"></div>
      <div class="title">Reporteros 2 ‚Ä¢ Unidad 5 ‚Ä¢ Lecci√≥n 2 ‚Äî <em>Los marcadores temporales y conectores</em> (v1)</div>
      <div class="namefields">
        <label>‚úç Nombre<br><input id="nf-nombre" class="nf" placeholder="Nombre"></label>
        <label>‚úç Apellido<br><input id="nf-apellido" class="nf" placeholder="Apellido"></label>
      </div>
    </div>
    <div class="route">
      <div class="route-line"><div id="routeFill" class="route-fill"></div></div>
      <div class="pinrow">
        <div id="pin1" class="pin" title="Parada 1">1</div>
        <div id="pin2" class="pin" title="Parada 2">2</div>
        <div id="pin3" class="pin" title="Parada 3">3</div>
        <div id="pin4" class="pin" title="Parada 4">4</div>
        <div id="pin5" class="pin" title="Parada 5">5</div>
      </div>
      <div class="voice-pill" title="Voice Settings">
        <span class="voice-label">üéôÔ∏è Voice:</span>
        <select id="voiceSelect"></select>
        <span class="voice-label">Rate</span>
        <input id="voiceRate" type="range" min="0.8" max="1.2" step="0.01" value="0.92">
        <span class="voice-label">Pitch</span>
        <input id="voicePitch" type="range" min="0.8" max="1.2" step="0.01" value="1.03">
      </div>
    </div>
  </header>

  <section class="section">
    <details>
      <summary>üìò Est√°ndares ACTFL ‚Äì 5 Cs / ACTFL Standards ‚Äì 5 Cs</summary>
      <ul>
        <li><b>Comunicaci√≥n / Communication:</b> Interpersonal (drag-drop, memory) e Interpretive (listening).</li>
        <li><b>Culturas / Cultures:</b> Expresiones temporales y conectores del discurso en contexto acad√©mico.</li>
        <li><b>Conexiones / Connections:</b> Organizaci√≥n temporal, escritura y presentaciones.</li>
        <li><b>Comparaciones / Comparisons:</b> Uso de marcadores en espa√±ol ‚Üî ingl√©s.</li>
        <li><b>Comunidades / Communities:</b> Comparte resultados en Schoology para practicar fuera de clase.</li>
      </ul>
    </details>
  </section>

  <!-- PARADA 1 -->
  <section class="section" id="p1">
    <h2>Parada 1 ‚Äî Empareja con √çcono / Match with Icon</h2>
    <p><b>Instructions:</b> Drag the <b>Spanish chip</b> onto the correct <b>English card</b>. <i>(Click any chip or card to hear it in Spanish.)</i></p>
    <div class="stopprog">
      <div class="mini-prog"><div class="mini-fill" id="p1Fill"></div></div>
      <div class="mini-txt" id="p1Txt">Correct: 0/12 ‚Ä¢ Acc: 0%</div>
    </div>
    <div id="p1Chip"></div>
    <div class="p1-row" id="p1Targets"></div>
  </section>

  <!-- PARADA 2 -->
  <section class="section" id="p2">
    <h2>Parada 2 ‚Äî Circunlocuci√≥n / Circumlocution</h2>
    <p><b>Instructions:</b></p>
    <ul>
      <li><b>En espa√±ol:</b> Escucha la descripci√≥n y elige la palabra correcta. Las pistas usan frases como: <i>Es algo que‚Ä¶, Es una acci√≥n que‚Ä¶, Es similar a‚Ä¶, Es como‚Ä¶, Es cuando‚Ä¶, Es lo contrario de‚Ä¶</i></li>
      <li><b>In English:</b> Listen to the description and choose the correct word. Clues begin with phrases like: <i>It‚Äôs something that‚Ä¶, It‚Äôs an action that‚Ä¶, It‚Äôs similar to‚Ä¶, It‚Äôs like‚Ä¶, It‚Äôs when‚Ä¶, It‚Äôs the opposite of‚Ä¶</i></li>
    </ul>
    <div class="stopprog">
      <div class="mini-prog"><div class="mini-fill" id="p2Fill"></div></div>
      <div class="mini-txt" id="p2Txt">Correct: 0/12 ‚Ä¢ Acc: 0%</div>
    </div>
    <div class="clue" id="p2Clue">Press ‚ñ∂Ô∏è to hear the clue.</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn olive" id="p2Play">‚ñ∂Ô∏è Listen</button>
      <button class="btn ghost" id="p2New">üîÑ New clue</button>
    </div>
    <div class="p2-options" id="p2Options"></div>
  </section>

  <!-- PARADA 3 -->
  <section class="section" id="p3">
    <h2>Parada 3 ‚Äî Memoria (Argentina) / Memory (Argentina)</h2>
    <p><b>Instructions:</b> Match all <b id="p3count"></b> unique pairs. Cards are removed and <b>not replaced</b>. Completion = all pairs matched (accuracy ignored). <i>(Click a card to hear the term in Spanish.)</i></p>
    <div class="stopprog">
      <div class="mini-prog"><div class="mini-fill" id="p3Fill"></div></div>
      <div class="mini-txt" id="p3Txt">Pairs: 0/0</div>
    </div>
    <div class="grid" id="p3Grid" aria-live="polite"></div>
    <div id="p3Banner" class="p3-banner" role="dialog" aria-modal="true" aria-labelledby="p3Title" aria-describedby="p3Desc">
      <div class="p3-card">
        <h3 id="p3Title">¬°Mapa completado! üó∫Ô∏è</h3>
        <p id="p3Desc">You matched all pairs. ¬°Excelente trabajo!</p>
        <button class="btn olive" id="p3Close">OK</button>
      </div>
    </div>
  </section>

  <!-- PARADA 4 -->
  <section class="section" id="p4">
    <h2>Parada 4 ‚Äî Construye Oraciones / Build Sentences</h2>
    <p><b>Instructions:</b> Drag the words to build the exact Spanish sentence. Then press <b>Grade</b>. <i>(Click any word to hear it.)</i></p>
    <div class="stopprog">
      <div class="mini-prog"><div class="mini-fill" id="p4Fill"></div></div>
      <div class="mini-txt" id="p4Txt">Correct: 0/12 ‚Ä¢ Acc: 0%</div>
    </div>
    <div id="p4Eng" class="hint"></div>
    <div id="p4Drop" class="dropzone" aria-label="Zona para construir la oraci√≥n / Sentence drop zone"></div>
    <div id="p4Bank" class="bank"></div>
    <div class="p4-controls">
      <button id="p4Grade" class="btn olive">‚úÖ Grade</button>
      <button id="p4Clear" class="btn ghost">üßΩ Clear</button>
      <button id="p4Next" class="btn navy">‚û°Ô∏è Next</button>
    </div>
  </section>

  <!-- PARADA 5 -->
  <section class="section" id="p5">
    <h2>Parada 5 ‚Äî Mini Listening</h2>
    <p><b>Instructions:</b> Press <b>‚ñ∂Ô∏è</b> to listen and choose the correct answer. <i>(Click options to hear them.)</i></p>
    <div class="stopprog">
      <div class="mini-prog"><div class="mini-fill" id="p5Fill"></div></div>
      <div class="mini-txt" id="p5Txt">Correct: 0/12 ‚Ä¢ Acc: 0%</div>
    </div>
    <div class="radio">
      <div id="disc" class="record" aria-hidden="true">‚ñ∂Ô∏è</div>
      <div>
        <div id="p5Prompt" style="margin-bottom:8px;">Press ‚ñ∂Ô∏è to play.</div>
        <div id="p5Options" class="p2-options"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn olive" id="p5Play">‚ñ∂Ô∏è Play</button>
          <button class="btn ghost" id="p5New">üîÑ New audio</button>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="postcard">
      <h3 style="margin:6px 0">üìä Summary</h3>
      <div id="sumStats">Attempts: 0 ‚Ä¢ Correct: 0 ‚Ä¢ Accuracy: 0%</div>
    </div>
    <div class="postcard">
      <h3 style="margin:6px 0">‚¨áÔ∏è Export</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="dlCSV" class="btn ghost">üìÆ Download CSV</button>
        <button id="dlJSON" class="btn ghost">üìú Download My Data (JSON)</button>
      </div>
      <p style="margin-top:10px"><i>Note:</i> Upload your file to <b>Schoology</b> in the assignment matching this page‚Äôs title.</p>
    </div>
  </footer>
</div>

<audio id="bgm" loop muted></audio>

<script>
/* ================= VOICES ================= */
const voiceSelect = document.getElementById("voiceSelect");
const voiceRate = document.getElementById("voiceRate");
const voicePitch = document.getElementById("voicePitch");

function loadVoicePrefs(){
  const v = localStorage.getItem("voicePref");
  const r = localStorage.getItem("voiceRate");
  const p = localStorage.getItem("voicePitch");
  if(r) voiceRate.value = r;
  if(p) voicePitch.value = p;
  if(v) voiceSelect.dataset.saved = v;
}
voiceRate.addEventListener("input", ()=>localStorage.setItem("voiceRate", voiceRate.value));
voicePitch.addEventListener("input", ()=>localStorage.setItem("voicePitch", voicePitch.value));
voiceSelect.addEventListener("change", ()=>localStorage.setItem("voicePref", voiceSelect.value));

function listVoices(){
  const all = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  const preferred = [];
  const others = [];
  all.forEach(v=>{
    const isEs = v.lang && v.lang.toLowerCase().startsWith("es");
    const isEsEs = v.lang && v.lang.toLowerCase().startsWith("es-es");
    const isGoogle = /Google/i.test(v.name);
    const score = (isEsEs?3:0) + (isEs?1:0) + (isGoogle?1:0);
    (score>0?preferred:others).push({v,score});
  });
  preferred.sort((a,b)=>b.score-a.score);
  const ordered = [...preferred.map(x=>x.v), ...others.map(x=>x.v)];
  ordered.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v.name + "::" + v.lang;
    opt.textContent = `${v.name} ‚Äî ${v.lang}`;
    voiceSelect.appendChild(opt);
  });
  const saved = voiceSelect.dataset.saved;
  if(saved && [...voiceSelect.options].some(o=>o.value===saved)){
    voiceSelect.value = saved;
  }else if(ordered.length){
    const best = preferred.length? preferred[0].v : ordered[0];
    voiceSelect.value = best.name + "::" + best.lang;
  }
}
loadVoicePrefs();
if(typeof speechSynthesis !== "undefined"){
  speechSynthesis.onvoiceschanged = ()=>{ listVoices(); };
  setTimeout(listVoices, 200);
}

function speakEs(text){
  try{
    const parts = (text || "").split(/([.!?;:])/).reduce((acc, cur)=>{
      if(/[.!?;:]/.test(cur) && acc.length){ acc[acc.length-1] += cur; }
      else if(cur.trim()){ acc.push(cur.trim()); }
      return acc;
    }, []);
    const selected = voiceSelect.value;
    const [vName, vLang] = selected? selected.split("::") : [null, null];
    const pickVoice = ()=>{
      const vs = speechSynthesis.getVoices();
      let match = vs.find(v=>v.name===vName && v.lang===vLang);
      if(!match){
        match = vs.find(v=>v.lang && v.lang.toLowerCase().startsWith("es-es"))
              || vs.find(v=>v.lang && v.lang.toLowerCase().startsWith("es"))
              || vs[0];
      }
      return match;
    };
    let delay = 0;
    const rate = parseFloat(voiceRate.value||"0.92");
    const pitch = parseFloat(voicePitch.value||"1.03");
    speechSynthesis.cancel();
    parts.forEach((p)=>{
      const utt = new SpeechSynthesisUtterance(p);
      utt.lang = "es-ES";
      const voice = pickVoice();
      if(voice) utt.voice = voice;
      utt.rate = rate;
      utt.pitch = pitch;
      utt.volume = 0.95;
      const pad = (/[.!?]$/.test(p) ? 180 : 120);
      setTimeout(()=>speechSynthesis.speak(utt), delay);
      delay += Math.max(250, p.length*12) + pad;
    });
  }catch(e){ console.warn(e); }
}

/* ================= DATA ================= */
// MASTER vocabulary for LOS MARCADORES TEMPORALES + CONECTORES
const MASTER = [
  // MARCADORES TEMPORALES
  {es:"en las pr√≥ximas d√©cadas", say:"en las pr√≥ximas d√©cadas", en:"in the next decades", icon:"üìÜ", cat:"time"},
  {es:"dentro de treinta a√±os", say:"dentro de treinta a√±os", en:"thirty years from now", icon:"‚è≥", cat:"time"},
  {es:"ya", say:"ya", en:"already", icon:"‚úÖ", cat:"time"},
  {es:"todav√≠a no", say:"todav√≠a no", en:"not yet", icon:"‚ùå", cat:"time"},
  {es:"pronto", say:"pronto", en:"soon", icon:"üïí", cat:"time"},
  {es:"en el futuro", say:"en el futuro", en:"in the future", icon:"üöÄ", cat:"time"},
  {es:"alg√∫n d√≠a", say:"alg√∫n d√≠a", en:"someday", icon:"üåü", cat:"time"},
  {es:"a partir de ahora", say:"a partir de ahora", en:"from now on", icon:"‚û°Ô∏è", cat:"time"},
  {es:"desde entonces", say:"desde entonces", en:"since then", icon:"üîô", cat:"time"},
  {es:"mientras tanto", say:"mientras tanto", en:"meanwhile", icon:"‚èØÔ∏è", cat:"time"},
  {es:"en ese momento", say:"en ese momento", en:"at that moment", icon:"üï∞Ô∏è", cat:"time"},
  {es:"m√°s tarde", say:"m√°s tarde", en:"later", icon:"üïü", cat:"time"},
  {es:"antes de + infinitivo", say:"antes de", en:"before + verb (e.g., antes de salir)", icon:"‚èÆÔ∏è", cat:"time"},
  {es:"despu√©s de + infinitivo", say:"despu√©s de", en:"after + verb (e.g., despu√©s de comer)", icon:"‚è≠Ô∏è", cat:"time"},
  {es:"hasta que + verbo", say:"hasta que", en:"until + verb (e.g., hasta que llegue)", icon:"üõë", cat:"time"},
  {es:"cuando + verbo", say:"cuando", en:"when + verb (e.g., cuando tenga tiempo)", icon:"üóìÔ∏è", cat:"time"},
  {es:"en cuanto + verbo", say:"en cuanto", en:"as soon as + verb", icon:"‚ö°", cat:"time"},
  {es:"tan pronto como + verbo", say:"tan pronto como", en:"as soon as + verb", icon:"‚ö°", cat:"time"},
  {es:"luego", say:"luego", en:"then / later", icon:"‚û°Ô∏è", cat:"time"},
  {es:"al final", say:"al final", en:"in the end", icon:"üèÅ", cat:"time"},
  {es:"a veces", say:"a veces", en:"sometimes", icon:"üîÅ", cat:"time"},
  {es:"de vez en cuando", say:"de vez en cuando", en:"from time to time", icon:"üîÇ", cat:"time"},
  {es:"cada vez que", say:"cada vez que", en:"every time that", icon:"‚ôªÔ∏è", cat:"time"},
  {es:"por fin", say:"por fin", en:"finally", icon:"üéâ", cat:"time"},
  {es:"desde hace + per√≠odo", say:"desde hace", en:"for (a duration of time)", icon:"üìè", cat:"time"},
  {es:"hace + per√≠odo", say:"hace", en:"(duration) ago", icon:"‚è∞", cat:"time"},
  {es:"hace poco", say:"hace poco", en:"recently", icon:"üì∞", cat:"time"},
  {es:"√∫ltimamente", say:"√∫ltimamente", en:"lately", icon:"üóûÔ∏è", cat:"time"},

  // CONECTORES
  {es:"a lo mejor / quiz√°(s)", say:"a lo mejor, quiz√°s", en:"maybe / perhaps", icon:"‚ùì", cat:"conn"},
  {es:"tal vez", say:"tal vez", en:"maybe / perhaps", icon:"‚ùî", cat:"conn"},
  {es:"porque", say:"porque", en:"because", icon:"üß©", cat:"conn"},
  {es:"ya que", say:"ya que", en:"since / given that", icon:"üìå", cat:"conn"},
  {es:"como", say:"como", en:"since / as", icon:"üìç", cat:"conn"},
  {es:"por eso", say:"por eso", en:"that‚Äôs why", icon:"‚û°Ô∏è", cat:"conn"},
  {es:"por lo tanto", say:"por lo tanto", en:"therefore", icon:"‚à¥", cat:"conn"},
  {es:"as√≠ que", say:"as√≠ que", en:"so / therefore", icon:"‚û°Ô∏è", cat:"conn"},
  {es:"sin embargo", say:"sin embargo", en:"however", icon:"‚öñÔ∏è", cat:"conn"},
  {es:"aunque", say:"aunque", en:"although / even though", icon:"ü§î", cat:"conn"},
  {es:"en cambio", say:"en cambio", en:"on the other hand", icon:"üîÑ", cat:"conn"},
  {es:"adem√°s", say:"adem√°s", en:"moreover / in addition", icon:"‚ûï", cat:"conn"},
  {es:"tambi√©n", say:"tambi√©n", en:"also", icon:"‚ûï", cat:"conn"},
  {es:"tampoco", say:"tampoco", en:"neither / not either", icon:"‚ûñ", cat:"conn"},
  {es:"por un lado‚Ä¶ por otro (lado)", say:"por un lado, por otro lado", en:"on one hand‚Ä¶ on the other", icon:"üëê", cat:"conn"},
  {es:"incluso", say:"incluso", en:"even / including", icon:"üß∑", cat:"conn"},
  {es:"sobre todo", say:"sobre todo", en:"above all", icon:"üèîÔ∏è", cat:"conn"},
  {es:"en resumen", say:"en resumen", en:"in summary", icon:"üßæ", cat:"conn"},
  {es:"en conclusi√≥n", say:"en conclusi√≥n", en:"in conclusion", icon:"‚úÖ", cat:"conn"},
  {es:"de hecho", say:"de hecho", en:"in fact", icon:"üß†", cat:"conn"}
];

// Circumlocution clues (Parada 2) ‚Äî use starters heavily
const P2_CLUES = [
  {clue:"Es una expresi√≥n para el futuro lejano; es similar a 'en muchos a√±os'.", ans:"en las pr√≥ximas d√©cadas"},
  {clue:"Es una expresi√≥n exacta de tiempo; es cuando pasa un per√≠odo de tres d√©cadas.", ans:"dentro de treinta a√±os"},
  {clue:"Es lo contrario de 'todav√≠a no'; indica que algo ya ocurri√≥.", ans:"ya"},
  {clue:"Es lo contrario de 'ya'; indica que algo no ha sucedido.", ans:"todav√≠a no"},
  {clue:"Es algo que pasa pronto; es dentro de poco tiempo.", ans:"pronto"},
  {clue:"Es similar a 'm√°s adelante'; se usa para hablar del porvenir.", ans:"en el futuro"},
  {clue:"Es una expresi√≥n para un plan lejano; es como 'alguna vez'.", ans:"alg√∫n d√≠a"},
  {clue:"Es el inicio de una nueva etapa; significa que desde este momento cambia algo.", ans:"a partir de ahora"},
  {clue:"Es una referencia al pasado; indica el punto desde el cual algo empez√≥.", ans:"desde entonces"},
  {clue:"Es para acciones paralelas; ocurre al mismo tiempo que otra cosa.", ans:"mientras tanto"},
  {clue:"Es un punto concreto en la narraci√≥n; equivale a 'justo entonces'.", ans:"en ese momento"},
  {clue:"Es similar a 'despu√©s'; indica un tiempo posterior.", ans:"m√°s tarde"},
  {clue:"Es antes de una acci√≥n; introduce infinitivo.", ans:"antes de + infinitivo"},
  {clue:"Es despu√©s de una acci√≥n; introduce infinitivo.", ans:"despu√©s de + infinitivo"},
  {clue:"Es hasta que ocurra otra acci√≥n; introduce verbo en subjuntivo a veces.", ans:"hasta que + verbo"},
  {clue:"Es cuando suceda algo; introduce una situaci√≥n temporal.", ans:"cuando + verbo"},
  {clue:"Es tan pronto como ocurra algo; es equivalente a 'apenas'.", ans:"en cuanto + verbo"},
  {clue:"Es tan pronto como ocurra algo; es equivalente a 'en cuanto'.", ans:"tan pronto como + verbo"},
  {clue:"Es una secuencia l√≥gica; es como 'despu√©s'.", ans:"luego"},
  {clue:"Es el cierre de una historia; marca el desenlace.", ans:"al final"},
  {clue:"Es una frecuencia baja; significa 'a veces'.", ans:"a veces"},
  {clue:"Es una frecuencia ocasional; es similar a 'a veces' pero menos regular.", ans:"de vez en cuando"},
  {clue:"Es cada ocasi√≥n repetida; introduce eventos que pasan repetidamente.", ans:"cada vez que"},
  {clue:"Es el t√©rmino de espera; indica satisfacci√≥n despu√©s de tiempo.", ans:"por fin"},
  {clue:"Es para expresar duraci√≥n; se usa con presente para acciones que contin√∫an.", ans:"desde hace + per√≠odo"},
  {clue:"Es para pasado; se usa para decir 'hace X tiempo'.", ans:"hace + per√≠odo"},
  {clue:"Es algo que ocurri√≥ recientemente; es como 'no hace mucho'.", ans:"hace poco"},
  {clue:"Es similar a 'hace poco', pero puede cubrir varias semanas; se√±ala cambios recientes.", ans:"√∫ltimamente"},

  // Conectores
  {clue:"Es una posibilidad; es similar a 'quiz√°s'.", ans:"tal vez"},
  {clue:"Es una causa; introduce la raz√≥n de algo.", ans:"porque"},
  {clue:"Es una causa dada; es equivalente a 'puesto que'.", ans:"ya que"},
  {clue:"Es una causa explicada; se usa al inicio como 'como' = 'ya que'.", ans:"como"},
  {clue:"Es una consecuencia directa; es equivalente a 'por esa raz√≥n'.", ans:"por eso"},
  {clue:"Es una conclusi√≥n l√≥gica; equivale a 'por consiguiente'.", ans:"por lo tanto"},
  {clue:"Es una consecuencia; es similar a 'por eso'.", ans:"as√≠ que"},
  {clue:"Es una oposici√≥n; es equivalente a 'no obstante'.", ans:"sin embargo"},
  {clue:"Es una concesi√≥n; admite una idea contraria.", ans:"aunque"},
  {clue:"Es un contraste; presenta otra perspectiva.", ans:"en cambio"},
  {clue:"Es una adici√≥n; introduce un punto extra.", ans:"adem√°s"},
  {clue:"Es una adici√≥n simple; significa 'also'.", ans:"tambi√©n"},
  {clue:"Es la negaci√≥n de 'tambi√©n'; significa 'neither'.", ans:"tampoco"},
  {clue:"Es una estructura doble; presenta dos perspectivas.", ans:"por un lado‚Ä¶ por otro (lado)"},
  {clue:"Es un √©nfasis; significa 'even'.", ans:"incluso"},
  {clue:"Es una prioridad; significa 'above all'.", ans:"sobre todo"},
  {clue:"Es una s√≠ntesis; cierra ideas brevemente.", ans:"en resumen"},
  {clue:"Es una conclusi√≥n final; cierra un texto.", ans:"en conclusi√≥n"},
  {clue:"Es un refuerzo; introduce un hecho comprobable.", ans:"de hecho"},
  {clue:"Es una posibilidad; tambi√©n significa 'quiz√°(s)'.", ans:"a lo mejor / quiz√°(s)"}
];

// Sentences (Parada 4) using markers & connectors
const P4_SENTENCES = [
  {es:"A partir de ahora estudiaremos cada d√≠a.", en:"From now on we will study every day."},
  {es:"En cuanto termine, te llamo.", en:"As soon as I finish, I‚Äôll call you."},
  {es:"Antes de salir, apaga las luces.", en:"Before leaving, turn off the lights."},
  {es:"Despu√©s de comer, hacemos la tarea.", en:"After eating, we do the homework."},
  {es:"Cada vez que practico, mejoro.", en:"Every time I practice, I improve."},
  {es:"Hace poco cambiamos de profesor.", en:"We changed teachers recently."},
  {es:"Por eso llegamos tarde.", en:"That‚Äôs why we are late."},
  {es:"Aunque llueva, vamos al entrenamiento.", en:"Even though it rains, we‚Äôre going to practice."},
  {es:"Tal vez lleguen m√°s tarde.", en:"Maybe they will arrive later."},
  {es:"Al final todos entendieron la explicaci√≥n.", en:"In the end everyone understood the explanation."},
  {es:"Mientras tanto prepara los materiales.", en:"Meanwhile prepare the materials."},
  {es:"En el futuro trabajaremos desde casa m√°s a menudo.", en:"In the future we will work from home more often."}
];

// Listening items (Parada 5)
const P5_ITEMS = [
  {tts:"Antes de salir, cierra la puerta y apaga la luz.", q:"¬øQu√© debes hacer primero?", options:["Cerrar la puerta y apagar la luz","Salir","Encender la luz"], correct:0},
  {tts:"En cuanto llegue el profesor, empezamos la actividad.", q:"¬øCu√°ndo empiezan la actividad?", options:["En cuanto llegue el profesor","M√°s tarde","Ayer"], correct:0},
  {tts:"Desde entonces estudiamos cada tarde en la biblioteca.", q:"¬øDesde cu√°ndo estudian en la biblioteca?", options:["Desde entonces","Ma√±ana","Por fin"], correct:0},
  {tts:"No han terminado todav√≠a; sin embargo, avanzaron mucho.", q:"¬øQu√© indica 'sin embargo'?", options:["Contraste","Causa","Conclusi√≥n"], correct:0},
  {tts:"Llegaron hace poco y todav√≠a no conocen la ciudad.", q:"¬øCu√°ndo llegaron?", options:["Recientemente","El a√±o pasado","Ma√±ana"], correct:0},
  {tts:"Por lo tanto, debemos practicar m√°s para el examen.", q:"¬øQu√© expresa 'por lo tanto'?", options:["Conclusi√≥n","Oposici√≥n","Tiempo pasado"], correct:0}
];

/* ================= STATE & UTILS ================= */
const GOAL_CORRECT = 12;
const GOAL_ACC = 0.80;
const state = { p1:{correct:0, attempts:0}, p2:{correct:0, attempts:0}, p3:{correct:0, attempts:0, matchedSet:new Set(), deck:[], complete:false}, p4:{correct:0, attempts:0, current:null}, p5:{correct:0, attempts:0, current:null} };

function pct(n){return Math.round(n*100);}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function sample(arr, n){return shuffle(arr.slice()).slice(0,n)}
function playStamp(){try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.type="square";o.frequency.value=120;g.gain.value=0.3;o.connect(g);g.connect(ctx.destination);o.start();setTimeout(()=>{g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.2)},10);setTimeout(()=>{o.stop();ctx.close()},220);}catch(e){}}
function confetti(){const el=document.createElement("div");el.style.position="fixed";el.style.inset="0";el.style.pointerEvents="none";document.body.appendChild(el);for(let i=0;i<60;i++){const s=document.createElement("div");s.textContent="‚úàÔ∏è";s.style.position="absolute";s.style.left=Math.random()*100+"%";s.style.top="-10px";s.style.fontSize=(12+Math.random()*18)+"px";s.style.transition="transform 1.2s ease-out, opacity 1.2s";el.appendChild(s);requestAnimationFrame(()=>{s.style.transform=`translateY(${window.innerHeight+40}px) rotate(${(Math.random()*720-360)}deg)`;s.style.opacity="0";});}setTimeout(()=>document.body.removeChild(el),1300);}
function normalizeSentence(s){return s.replace(/\s+/g," ").replace(/\s+([.,!?;:])/g,"$1").trim();}
function speakItem(spanishEs){const found=MASTER.find(x=>x.es===spanishEs);speakEs(found?.say || spanishEs);}
function meets(id, data){ if(id==="p3"){return data.matchedSet.size >= MASTER.length;} return data.correct>=GOAL_CORRECT && (data.correct/Math.max(1,data.attempts))>=GOAL_ACC; }
function updateStopBars(){
  const items=[{id:"p1",data:state.p1},{id:"p2",data:state.p2},{id:"p3",data:state.p3},{id:"p4",data:state.p4},{id:"p5",data:state.p5}];
  let completed=0;
  items.forEach((it,idx)=>{
    const fEl=document.getElementById(it.id+"Fill"); const tEl=document.getElementById(it.id+"Txt");
    if(it.id==="p3"){
      const matched = it.data.matchedSet.size; const total = MASTER.length;
      const fill = Math.min(100, Math.round((matched/total)*100));
      if(fEl){fEl.style.width=fill+"%"; fEl.classList.toggle("meets", meets("p3",it.data));}
      if(tEl){tEl.textContent=`Pairs: ${matched}/${total}`;}
    }else{
      const acc = it.data.attempts? it.data.correct/it.data.attempts : 0;
      const fill = Math.min(100, Math.round((it.data.correct/GOAL_CORRECT)*100));
      if(fEl){fEl.style.width=fill+"%"; fEl.classList.toggle("meets", meets(it.id,it.data));}
      if(tEl){tEl.textContent=`Correct: ${it.data.correct}/${GOAL_CORRECT} ‚Ä¢ Acc: ${pct(acc)}%`; }
    }
    const pinEl=document.getElementById("pin"+(idx+1)); if(pinEl) pinEl.classList.toggle("done", meets(it.id,it.data));
    if(meets(it.id,it.data)) completed++;
  });
  document.getElementById("routeFill").style.width=(completed/5*100)+"%";
  if(completed===5){confetti(); playStamp();}
  const totalAttempts=items.reduce((a,b)=>a+b.data.attempts,0);
  const totalCorrect=items.reduce((a,b)=>a+b.data.correct,0);
  const acc= totalAttempts? totalCorrect/totalAttempts : 0;
  document.getElementById("sumStats").textContent=`Attempts: ${totalAttempts} ‚Ä¢ Correct: ${totalCorrect} ‚Ä¢ Accuracy: ${pct(acc)}%`;
}

/* ================= PARADA 1 ================= */
const p1Chip=document.getElementById("p1Chip");
const p1Targets=document.getElementById("p1Targets");
let p1Current=null; let p1Recent=[];
function p1NewRound(){
  const pool=MASTER.filter(v=>!p1Recent.includes(v.es));
  const chosen=pool.length? pool[Math.floor(Math.random()*pool.length)] : MASTER[Math.floor(Math.random()*MASTER.length)];
  p1Current=chosen; p1Recent.push(chosen.es); if(p1Recent.length>5) p1Recent.shift();
  const sameCat = MASTER.filter(v=>v.cat===chosen.cat && v.es!==chosen.es);
  const from = sameCat.length>=3 ? sameCat : MASTER.filter(v=>v.es!==chosen.es);
  const distractors=sample(from,3);
  const set=shuffle([{...chosen,correct:true},...distractors.map(d=>({...d,correct:false}))]);
  p1Chip.innerHTML=`<div draggable="true" class="spanish-chip" id="p1Drg" role="button" tabindex="0">${chosen.icon} <span>${chosen.es}</span></div>`;
  const drg = document.getElementById("p1Drg");
  drg.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain","chip"); });
  drg.addEventListener("click", ()=>speakItem(chosen.es));
  drg.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ speakItem(chosen.es);} });
  p1Targets.innerHTML="";
  set.forEach(t=>{
    const dz=document.createElement("div");
    dz.className="target"; dz.dataset.correct = t.correct? "1":"0";
    dz.innerHTML=`<div><span class="icon">${t.icon||""}</span><b>${t.en}</b></div><div class="drop-here">Drop here</div>`;
    dz.addEventListener("dragover", e=>e.preventDefault());
    dz.addEventListener("drop", e=>{
      e.preventDefault(); state.p1.attempts++;
      if(dz.dataset.correct==="1"){ state.p1.correct++; dz.classList.add("correct"); playStamp();
        p1Chip.innerHTML=`<div class="spanish-chip" style="opacity:.6">${t.icon||""} <span>${chosen.es}</span></div>`;
        setTimeout(()=>{p1NewRound(); updateStopBars();}, 450);
      }else{ dz.classList.add("wrong"); setTimeout(()=>dz.classList.remove("wrong"),300); updateStopBars(); }
    });
    dz.addEventListener("click", ()=>speakItem(chosen.es));
    dz.setAttribute("tabindex","0");
    dz.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") speakItem(chosen.es); });
    p1Targets.appendChild(dz);
  });
}
p1NewRound();

/* ================= PARADA 2 ================= */
const p2Clue=document.getElementById("p2Clue");
const p2Options=document.getElementById("p2Options");
const btnP2Play=document.getElementById("p2Play");
const btnP2New=document.getElementById("p2New");
let p2Current=null;
function p2New(){
  p2Current=P2_CLUES[Math.floor(Math.random()*P2_CLUES.length)];
  p2Clue.textContent=p2Current.clue;
  const corr=MASTER.find(v=>v.es===p2Current.ans);
  const pool=MASTER.filter(v=>v.es!==p2Current.ans);
  const opts=shuffle([corr,...sample(pool,3)]);
  p2Options.innerHTML="";
  opts.forEach(o=>{
    const b=document.createElement("button");
    b.className="btn ghost";
    b.textContent=`${o.icon||""} ${o.es}`.trim();
    b.addEventListener("click", ()=>{
      speakItem(o.es);
      state.p2.attempts++;
      if(o.es===p2Current.ans){ state.p2.correct++; playStamp(); b.classList.add("correct"); }
      else { b.classList.add("wrong"); }
      [...p2Options.querySelectorAll("button")].forEach(bb=>bb.disabled=true);
      updateStopBars(); setTimeout(()=>p2New(), 900);
    });
    p2Options.appendChild(b);
  });
}
btnP2Play.addEventListener("click", ()=>{ if(p2Current) speakEs(p2Current.clue); });
btnP2New.addEventListener("click", p2New);
p2New();

/* ================= PARADA 3 ================= */
const p3Grid=document.getElementById("p3Grid");
const p3Banner=document.getElementById("p3Banner");
const p3Close=document.getElementById("p3Close");
let p3First=null, p3Lock=false;
function p3InitDeckAll(){
  state.p3.deck=[];
  MASTER.forEach(item=>{
    state.p3.deck.push({type:"es", key:item.es, text:item.es, icon:item.icon, pair:item.en, _gone:false});
    state.p3.deck.push({type:"en", key:item.en, text:item.en, icon:item.icon, pair:item.es, _gone:false});
  });
  state.p3.deck=shuffle(state.p3.deck);
  document.getElementById("p3count").textContent = MASTER.length;
  document.getElementById("p3Txt").textContent = `Pairs: 0/${MASTER.length}`;
}
function p3Render(){
  p3Grid.innerHTML="";
  state.p3.deck.forEach((card,i)=>{
    if(card._gone) return;
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<div class="face back"><div class="flag"><div class="sun"></div></div></div>
                 <div class="face front"><div><div style="font-size:24px">${card.icon||"üß≥"}</div><div>${card.text}</div></div></div>`;
    c.addEventListener("click", ()=>p3Flip(c, card, i));
    c.setAttribute("tabindex","0");
    c.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ p3Flip(c, card, i);} });
    p3Grid.appendChild(c);
  });
  p3Grid.classList.toggle("locked", state.p3.complete);
}
function p3ShowBanner(){ p3Banner.classList.add("show"); p3Grid.classList.add("locked"); p3Banner.querySelector("button")?.focus?.(); confetti(); playStamp(); }
p3Close.addEventListener("click", ()=>{ p3Banner.classList.remove("show"); });
function p3Flip(el, card, idx){
  if(state.p3.complete) return;
  if(p3Lock || el.classList.contains("gone") || el.classList.contains("flipped")) return;
  el.classList.add("flipped");
  if(card.type==="es"){ speakItem(card.text); } else { speakItem(card.pair); }
  if(!p3First){ p3First={el,card,idx}; return; }
  p3Lock=true;
  const first=p3First; p3First=null;
  setTimeout(()=>{
    state.p3.attempts++;
    const isMatch = (first.card.type!=="es" ? first.card.pair===card.text : first.card.pair===card.text)
                 || (card.type!=="es" ? card.pair===first.card.text : card.pair===first.card.text);
    const sameIcon = first.card.icon===card.icon;
    if(isMatch && sameIcon){
      state.p3.correct++;
      const keyEs = first.card.type==="es" ? first.card.key : first.card.pair;
      state.p3.matchedSet.add(keyEs);
      first.el.classList.add("gone"); first.el.style.visibility="hidden";
      el.classList.add("gone"); el.style.visibility="hidden";
      state.p3.deck[first.idx]._gone=true; state.p3.deck[idx]._gone=true;
      if(state.p3.matchedSet.size===MASTER.length){
        state.p3.complete=true; updateStopBars(); p3Render();
        document.getElementById("p3").scrollIntoView({behavior:"smooth", block:"center"});
        setTimeout(p3ShowBanner, 250); p3Lock=false; return;
      }
      playStamp();
    }else{
      first.el.classList.remove("flipped"); el.classList.remove("flipped");
    }
    p3Lock=false; updateStopBars();
  }, 420);
}
p3InitDeckAll(); p3Render();

/* ================= PARADA 4 ================= */
const p4Eng=document.getElementById("p4Eng");
const p4Drop=document.getElementById("p4Drop");
const p4Bank=document.getElementById("p4Bank");
const p4Grade=document.getElementById("p4Grade");
const p4Clear=document.getElementById("p4Clear");
const p4Next=document.getElementById("p4Next");

function tokenize(sentence){ return sentence.replace(/([.,!?])/g," $1 ").trim().split(/\s+/); }
function p4Load(){
  state.p4.current=P4_SENTENCES[Math.floor(Math.random()*P4_SENTENCES.length)];
  p4Eng.textContent=state.p4.current.en;
  p4Drop.innerHTML=""; p4Bank.innerHTML="";
  const tokens=tokenize(state.p4.current.es);
  const shuffled=shuffle(tokens.slice());
  shuffled.forEach(tok=>{
    const chip=document.createElement("span");
    chip.className="chip"; chip.textContent=tok; chip.draggable=true;
    chip.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain", tok); chip.classList.add("dragging"); });
    chip.addEventListener("dragend", ()=>chip.classList.remove("dragging"));
    chip.addEventListener("click", ()=>speakEs(tok));
    chip.setAttribute("tabindex","0");
    chip.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ speakEs(tok);} });
    p4Bank.appendChild(chip);
  });
}
["dragover","drop"].forEach(evt=>{
  p4Drop.addEventListener(evt, e=>{ e.preventDefault(); if(evt==="drop"){ const dragging=document.querySelector(".chip.dragging"); if(dragging){ p4Drop.appendChild(dragging); } } });
  p4Bank.addEventListener(evt, e=>{ e.preventDefault(); if(evt==="drop"){ const dragging=document.querySelector(".chip.dragging"); if(dragging){ p4Bank.appendChild(dragging); } } });
});
p4Grade.addEventListener("click", ()=>{
  const built=[...p4Drop.querySelectorAll(".chip")].map(c=>c.textContent).join(" ");
  const ok = normalizeSentence(built)===normalizeSentence(state.p4.current.es);
  state.p4.attempts++;
  if(ok){ state.p4.correct++; playStamp(); p4Eng.textContent="PASAPORTE APROBADO ‚úì / PASSPORT APPROVED ‚úì"; }
  else { p4Eng.textContent="Revisa el orden / Check the order"; p4Drop.classList.add("wrong"); setTimeout(()=>p4Drop.classList.remove("wrong"),300); }
  updateStopBars();
});
p4Clear.addEventListener("click", ()=>{ [...p4Drop.querySelectorAll(".chip")].forEach(c=>p4Bank.appendChild(c)); });
p4Next.addEventListener("click", p4Load);
p4Load();

/* ================= PARADA 5 ================= */
const disc=document.getElementById("disc");
const p5Prompt=document.getElementById("p5Prompt");
const p5Options=document.getElementById("p5Options");
const btnP5Play=document.getElementById("p5Play");
const btnP5New=document.getElementById("p5New");
function p5New(){
  state.p5.current=P5_ITEMS[Math.floor(Math.random()*P5_ITEMS.length)];
  p5Prompt.textContent=state.p5.current.q;
  p5Options.innerHTML="";
  state.p5.current.options.forEach((opt,i)=>{
    const b=document.createElement("button"); b.className="btn ghost"; b.textContent=opt;
    b.addEventListener("click", ()=>{
      speakEs(opt);
      state.p5.attempts++; if(i===state.p5.current.correct){ state.p5.correct++; b.classList.add("correct"); playStamp(); } else { b.classList.add("wrong"); }
      [...p5Options.querySelectorAll("button")].forEach(bb=>bb.disabled=true);
      updateStopBars(); setTimeout(()=>p5New(), 800);
    });
    b.setAttribute("aria-label", "opci√≥n");
    p5Options.appendChild(b);
  });
}
function p5Speak(){ if(state.p5.current) speakEs(state.p5.current.tts); }
btnP5Play.addEventListener("click", ()=>{disc.classList.add("playing"); p5Speak(); setTimeout(()=>disc.classList.remove("playing"), 1700)});
btnP5New.addEventListener("click", p5New);
p5New();

/* ================= EXPORT ================= */
document.getElementById("dlCSV").addEventListener("click", ()=>{
  const nombre=document.getElementById("nf-nombre").value||"";
  const apellido=document.getElementById("nf-apellido").value||"";
  const rows=[
    ["Nombre","Apellido","Parada","Correct","Attempts","Accuracy","P3 Unique Pairs"],
    [nombre,apellido,"1",state.p1.correct,state.p1.attempts,(state.p1.attempts? (state.p1.correct/state.p1.attempts).toFixed(2):"0"),""],
    [nombre,apellido,"2",state.p2.correct,state.p2.attempts,(state.p2.attempts? (state.p2.correct/state.p2.attempts).toFixed(2):"0"),""],
    [nombre,apellido,"3",state.p3.correct,state.p3.attempts,(state.p3.attempts? (state.p3.correct/state.p3.attempts).toFixed(2):"0"), state.p3.matchedSet.size+"/"+MASTER.length],
    [nombre,apellido,"4",state.p4.correct,state.p4.attempts,(state.p4.attempts? (state.p4.correct/state.p4.attempts).toFixed(2):"0"),""],
    [nombre,apellido,"5",state.p5.correct,state.p5.attempts,(state.p5.attempts? (state.p5.correct/state.p5.attempts).toFixed(2):"0"),""]
  ];
  const csv=rows.map(r=>r.join(",")).join("\n");
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download="Reporteros2_U5_L2_Marcadores_temporales_y_conectores_resultados_v1.csv"; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),500);
});
document.getElementById("dlJSON").addEventListener("click", ()=>{
  const payload={
    titulo:document.title,
    nombre:document.getElementById("nf-nombre").value||"",
    apellido:document.getElementById("nf-apellido").value||"",
    fecha:new Date().toISOString(),
    resultados:{
      p1:state.p1, p2:state.p2, p3:{correct:state.p3.correct, attempts:state.p3.attempts, matchedCount:state.p3.matchedSet.size, complete:state.p3.complete}, p4:state.p4, p5:state.p5
    }
  };
  const pretty=JSON.stringify(payload,null,2);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([pretty],{type:'application/json'}));
  a.download="Reporteros2_U5_L2_Marcadores_temporales_y_conectores_mis_datos_v1.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),500);
});

// Init
updateStopBars();
</script>
</body>
</html>
