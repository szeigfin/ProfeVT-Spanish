<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>reporteros2_unidad5_leccion2_condicional</title>
<style>
  :root{--bg:#f8fafc;--card:#fff;--ink:#0f172a;--muted:#475569;--accent:#0ea5e9;--ok:#16a34a;--bad:#dc2626;--chip:#e2e8f0}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;line-height:1.45}
  header{padding:14px;background:linear-gradient(90deg,#0ea5e9,#22c55e);color:#fff;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header .brand{font-weight:900;background:rgba(255,255,255,.18);padding:4px 10px;border-radius:999px}
  header h1{margin:0;font-size:1.06rem}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px 64px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.06);padding:16px;margin:12px 0}
  .dir{font-size:.95rem;color:var(--muted);border-left:4px solid var(--accent);padding-left:10px;margin:6px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;background:#e2e8f0;border-radius:999px;padding:.2rem .6rem;font-size:.8rem}
  .small{font-size:.92rem;color:var(--muted)}
  .kbd{font-family:ui-monospace, Menlo, Consolas, monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-bottom-width:3px;padding:2px 6px;border-radius:6px}
  .primary{background:#0ea5e9;color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
  .ghost{background:#eef2ff;border:1px solid #c7d2fe;color:#111827;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
  .q{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:8px}
  .q.correct{border-color:#86efac;background:#f0fdf4}
  .q.incorrect{border-color:#fecaca;background:#fff7f7}
  .feedback{margin-top:6px;font-size:.95rem;min-height:1.2em}
  .good{color:#065f46}.bad{color:#b91c1c}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{background:var(--chip);padding:6px 10px;border-radius:999px;font-weight:700;cursor:grab;user-select:none;border:1px solid #cbd5e1}
  .chip.sel{outline:3px solid #2563eb}
  .box6{width:100%;border-collapse:separate;border-spacing:10px}
  .box6 td{border:2px dashed #cbd5e1;border-radius:10px;min-height:58px;padding:6px 8px;vertical-align:top;background:#f8fafc;position:relative}
  .hintPron{position:absolute;top:6px;left:8px;font-size:.8rem;color:#64748b}
  .dropzone{min-height:46px;padding-top:16px;display:flex;gap:6px;flex-wrap:wrap}
  .flash-bad{animation:bad .35s ease}
  .flash-ok{animation:ok .35s ease}
  @keyframes bad{0%{background:#fff1f2}100%{background:#f8fafc}}
  @keyframes ok{0%{background:#ecfdf5}100%{background:#f8fafc}}
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr} }
  .fade-out{animation:fade .6s ease forwards}
  @keyframes fade{from{opacity:1}to{opacity:0}}
  .collap-btn{width:100%;text-align:left;display:flex;align-items:center;justify-content:space-between}
  .collap-body{max-height:0;overflow:hidden;transition:max-height .5s ease,padding .4s ease;padding:0 12px}

  /* A2/A4 helpers */
  .dropzone.a4 {min-height:56px;padding:10px;border:2px dashed #cbd5e1;border-radius:12px;background:#f8fafc}
  .chip.dragging{opacity:.6}

  /* A5 table layout */
  .a5-table{width:100%;border-collapse:separate;border-spacing:8px}
  .a5-table td{vertical-align:top}
  .a5-left{width:48%;border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:10px}
  .a5-right{width:52%;border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:10px}
  .slot{min-height:44px;border:2px dashed #cbd5e1;border-radius:10px;background:#f8fafc;padding:6px;display:flex;gap:6px;flex-wrap:wrap}
  .half{padding:6px;border:1px solid #cbd5e1;border-radius:10px;background:#eef2ff;cursor:grab;user-select:none}
  .highlight{outline:3px solid #16a34a}
  .shake{animation:shake .35s}
  @keyframes shake { 10%, 90% {transform: translateX(-1px);} 20%, 80% {transform: translateX(2px);} 30%, 50%, 70% {transform: translateX(-4px);} 40%, 60% {transform: translateX(4px);} }
</style>
</head>
<body>
<header>
  <span class="brand">ProfeVT</span>
  <h1>reporteros2_unidad5_leccion2 ‚Äî El condicional</h1>
  <div style="margin-left:auto" class="small">Nombre / Name:
    <input id="studentName" placeholder="Tu nombre‚Ä¶" style="max-width:240px">
  </div>
</header>

<div class="wrap">

  <!-- I CAN + ACTFL -->
  <section class="card">
    <h2 style="margin:.2rem 0 .6rem">Objetivos & ACTFL</h2>
    <p class="dir"><b>I can</b> (EN): use the <b>conditional</b> to talk about hypothetical situations, give suggestions/polite advice, and express wishes.</p>
    <p class="dir"><b>Yo puedo</b> (ES): usar el <b>condicional</b> para hip√≥tesis, sugerencias/consejos y deseos.</p>
    <p class="small"><b>Standards:</b> ACTFL 1.1, 1.2, 2.1, 3.1, 4.1, 5.1.</p>
  </section>

  <!-- COLLAPSIBLE WHEN/HOW -->
  <section class="card">
    <button id="toggleCondInfo" class="primary collap-btn">
      üìò When do we use the conditional? / ¬øCu√°ndo lo usamos?
      <span id="arrowCond">‚ñº</span>
    </button>
    <div id="condInfo" class="collap-body">
      <h3>WHEN DO WE USE IT? / ¬øCU√ÅNDO LO USAMOS?</h3>
      <p class="dir">
        ‚Ä¢ <b>Hypothetical situations</b> (present/future): <i>En un mundo ideal, tendr√≠amos cuatro meses de vacaciones.</i><br>
        ‚Ä¢ <b>Suggestions / advice</b>: <i>Yo que t√∫, estudiar√≠a Periodismo o Comunicaci√≥n; escribes muy bien.</i><br>
        ‚Ä¢ <b>Wishes</b>: <i>Este verano me gustar√≠a hacer un voluntariado en las islas Gal√°pagos.</i>
      </p>
      <h3>HOW DO YOU CONJUGATE REGULAR VERBS? / ¬øC√ìMO SE CONJUGA?</h3>
      <p class="dir">Infinitive + endings: <span class="kbd">-√≠a, -√≠as, -√≠a, -√≠amos, -√≠ais, -√≠an</span></p>
      <p class="small"><b>Irregular stems (ref.):</b> tener‚Üítendr-, poder‚Üípodr-, decir‚Üídir-, hacer‚Üíhar-, querer‚Üíquerr-, saber‚Üísabr-, salir‚Üísaldr-, venir‚Üívendr-, poner‚Üípondr-, haber‚Üíhabr-</p>
    </div>
  </section>

  <!-- ACTIVITY 1 -->
  <section class="card" id="a1">
    <h3>Actividad 1 ‚Äî Clasifica las terminaciones (la ‚Äúcaja de seis‚Äù)</h3>
    <p class="dir">ES: Arrastra o haz clic en una ficha y col√≥cala en la casilla correcta. EN: Drag or click a chip and place it in the correct pronoun box.</p>
    <div class="chips" id="a1Bank"></div>
    <table class="box6">
      <tr>
        <td data-pron="yo"><span class="hintPron">yo</span><div class="dropzone"></div></td>
        <td data-pron="nosotros"><span class="hintPron">nosotros/as</span><div class="dropzone"></div></td>
      </tr>
      <tr>
        <td data-pron="tu"><span class="hintPron">t√∫</span><div class="dropzone"></div></td>
        <td data-pron="vosotros"><span class="hintPron">vosotros/as</span><div class="dropzone"></div></td>
      </tr>
      <tr>
        <td data-pron="el"><span class="hintPron">√©l/ella/usted</span><div class="dropzone"></div></td>
        <td data-pron="ellos"><span class="hintPron">ellos/ellas/ustedes</span><div class="dropzone"></div></td>
      </tr>
    </table>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="ghost" id="a1Reset">Reiniciar</button>
      <button class="primary" id="a1Check">Comprobar</button>
    </div>
    <div class="pill" id="a1Score">Correctos: 0 / 6</div>
  </section>

  <!-- ACTIVITY 2 -->
  <section class="card" id="a2">
    <h3>Actividad 2 ‚Äî Ordena: ¬øregular o irregular?</h3>
    <p class="dir">ES: Clasifica cada <b>conjugaci√≥n en condicional</b> como <b>regular</b> (infinitivo + terminaci√≥n) o <b>irregular</b> (ra√≠z especial). EN: Sort each conditional form into Regular or Irregular.</p>
    <div class="chips" id="a2Bank"></div>
    <div class="grid2">
      <div class="q">
        <b>REGULARES</b>
        <div class="dropzone" id="a2Reg"></div>
      </div>
      <div class="q">
        <b>IRREGULARES (ra√≠z)</b>
        <div class="dropzone" id="a2Irr"></div>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="ghost" id="a2Reset">Reiniciar</button>
      <button class="primary" id="a2Check">Comprobar</button>
    </div>
    <div class="pill" id="a2Score">Correctos: 0 / 12</div>
  </section>

  <!-- ACTIVITY 3 -->
  <section class="card" id="a3">
    <h3>Actividad 3 ‚Äî Uso + forma en condicional</h3>
    <p class="dir">ES: Elige el <b>uso</b> (hipot√©tico / sugerencia / deseo) y escribe la forma correcta en condicional. EN: Choose the <b>use</b> and type the correct conditional form.</p>
    <div id="a3List"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="ghost" id="a3Reset">Reiniciar</button>
      <button class="primary" id="a3Check">Comprobar</button>
    </div>
    <div class="pill" id="a3Score">Correctos: 0 / 8</div>
  </section>

  <!-- ACTIVITY 4 -->
  <section class="card" id="a4">
    <h3>Actividad 4 ‚Äî Construye la oraci√≥n en condicional (reordena)</h3>
    <p class="dir">ES: Haz clic o arrastra fichas para formar la oraci√≥n. Reordena arrastrando <b>dentro</b> del cuadro de respuesta. EN: Click/drag to build; drag <b>within</b> the box to reorder.</p>
    <div class="q">
      <div class="chips" id="a4Bank"></div>
      <div class="dropzone a4" id="a4Drop" aria-label="√Årea de respuesta"></div>
      <div class="feedback" id="a4Fb"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="ghost" id="a4Reset">Reiniciar</button>
        <button class="primary" id="a4Check">Comprobar</button>
      </div>
      <div class="small" id="a4Hint" style="margin-top:6px;color:#2563eb"></div>
      <div class="pill" id="a4Score">Correctos: 0 / 5</div>
    </div>
  </section>

  <!-- ACTIVITY 5 -->
  <section class="card" id="a5">
    <h3>Actividad 5 ‚Äî ‚ÄúSi‚Ä¶‚Äù a la izquierda + resultado en condicional a la derecha</h3>
    <p class="dir">ES: Observa la cl√°usula con <b>si</b> (izquierda). Arrastra o haz clic en la cl√°usula correcta en condicional (desde el banco) y col√≥cala en el <b>espacio de la derecha</b>. EN: See the <b>si</b>-clause on the left; drag/click the right conditional result into the right-side space.</p>

    <table class="a5-table">
      <tbody id="a5Rows"></tbody>
    </table>

    <div class="q" style="margin-top:10px">
      <b>Banco de respuestas (condicional)</b>
      <div id="a5Bank" class="chips"></div>
      <div class="row" style="justify-content:flex-end;margin-top:6px">
        <button class="ghost" id="a5Shuffle">Mezclar</button>
        <button class="ghost" id="a5HintBtn">Pista</button>
        <button class="ghost" id="a5Reset">Reiniciar</button>
        <button class="primary" id="a5Check">Comprobar</button>
      </div>
      <div class="pill" id="a5Score">Correctos: 0 / 6</div>
    </div>
  </section>

  <!-- COLLAPSIBLE: Si + Past Subjunctive + Conditional -->
  <section class="card">
    <button id="toggleSiImp" class="primary collap-btn">
      üîé Si + imperfecto de subjuntivo + condicional ‚Äî ¬øC√≥mo funciona?
      <span id="arrowSiImp">‚ñº</span>
    </button>
    <div id="siImpInfo" class="collap-body">
      <h3>Relaci√≥n de tiempos (significado claro)</h3>
      <p class="dir">
        <b>Estructura / Pattern:</b> <i>Si + imperfecto de subjuntivo</i>, <i>condicional</i>.<br>
        <b>Idea central / Core meaning:</b> La cl√°usula con <i>si</i> describe una situaci√≥n
        <u>no real / contraria a la realidad</u> en el presente. Con el <b>condicional</b> decimos lo que
        <u>podr√≠a / pasar√≠a</u> <i>si eso fuera verdad</i>.<br>
        <span class="small">Now it isn‚Äôt true ‚Üí (hypothesis) ‚Üí If it <i>were</i> true, the second part <i>would/could</i> be true.</span>
      </p>

      <h3>Ejemplos con interpretaci√≥n</h3>
      <p class="dir">
        ‚Ä¢ Si <i>tuvi√©ramos</i> paneles solares, <b>pagar√≠amos</b> menos por la luz.<br>
        <span class="small">We don‚Äôt have them ‚Üí If we had them, we would pay less.</span><br><br>
        ‚Ä¢ Si <i>pudieras</i> venir ma√±ana, <b>terminar√≠amos</b> el proyecto.<br>
        <span class="small">You can‚Äôt/aren‚Äôt coming now ‚Üí If you could, we would finish it.</span>
      </p>

      <h3>C√≥mo formar el <i>imperfecto de subjuntivo</i> (r√°pido)</h3>
      <p class="dir">
        1) Ellos en pret√©rito: <i>tuvieron, fueron, pudieron, hicieron, vinieron‚Ä¶</i><br>
        2) Quita <b>-ron</b>: <i>tuvie-, fue-, pudie-, hicie-, vinie-</i>‚Ä¶<br>
        3) A√±ade: <span class="kbd">-ra, -ras, -ra, -ramos, -rais, -ran</span> (acento antes de <i>-ramos</i>).<br>
        <span class="small">Ej.: <i>tuviera/tuvieran, fuera/fueran, pudiera/pudieran, hiciera, viniera‚Ä¶</i></span>
      </p>

      <h3>Evita estos errores comunes</h3>
      <p class="dir">
        ‚ùå <i>Si tendr√≠a</i> tiempo, <i>viajar√≠a</i>‚Ä¶ ‚Üí ‚úÖ <b>Si <i>tuviera</i></b> tiempo, <b><i>viajar√≠a</i></b>‚Ä¶<br>
        ‚ùå Mezclar presente con condicional para lo irreal.<br>
        ‚úÖ Real/posible: <i>Si tengo</i> tiempo, <i>voy/ir√©</i>‚Ä¶ (no subjuntivo, no condicional).
      </p>
    </div>
  </section>

  <!-- REPORT -->
  <section class="card">
    <h2>Informe / Report (.txt)</h2>
    <pre id="reportPreview">‚Äî Pulsa ‚ÄúActualizar vista previa‚Äù ‚Äî</pre>
    <div class="row" style="justify-content:flex-end">
      <button class="ghost" id="previewBtn">Actualizar vista previa</button>
      <button class="ghost" id="copyBtn">Copiar</button>
      <button class="primary" id="downloadReport">Descargar (.txt)</button>
    </div>
  </section>

</div>

<script>
/* ---------- TTS (Spanish voice) ---------- */
let ES_VOICE=null;
function pickEsVoice(){
  const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
  ES_VOICE = voices.find(v=>/^(es-|es_)/i.test(v.lang)) ||
             voices.find(v=>/spanish/i.test(v.name)) || null;
}
if('speechSynthesis' in window){
  pickEsVoice();
  window.speechSynthesis.onvoiceschanged = pickEsVoice;
}

// Make endings like "-√≠a" speak as "√≠a" (strip leading hyphen for audio only)
function sayForChip(txt){
  const s = String(txt).trim();
  return s.startsWith('-') ? s.slice(1) : s;
}
function speakEs(text){
  if(!('speechSynthesis' in window)) return;
  const toSay = sayForChip(text);
  const u = new SpeechSynthesisUtterance(String(toSay));
  if(ES_VOICE){ u.voice = ES_VOICE; u.lang = ES_VOICE.lang; } else { u.lang = 'es-ES'; }
  u.rate = 1.0; u.pitch = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

/* ---------- helpers ---------- */
function stripAccents(s){ return s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function norm(s){ return stripAccents(String(s||'').trim().toLowerCase().replace(/\s+/g,' ')); }
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x; }

/* ---------- collapsibles ---------- */
const btn=document.getElementById('toggleCondInfo');
const info=document.getElementById('condInfo');
const arrow=document.getElementById('arrowCond');
btn.addEventListener('click',()=>{
  if(info.style.maxHeight==='0px' || !info.style.maxHeight){
    info.style.maxHeight=info.scrollHeight+'px'; info.style.padding='12px'; arrow.textContent='‚ñ≤';
  }else{ info.style.maxHeight='0'; info.style.padding='0 12px'; arrow.textContent='‚ñº'; }
});
const btnSi=document.getElementById('toggleSiImp');
const infoSi=document.getElementById('siImpInfo');
const arrowSi=document.getElementById('arrowSiImp');
btnSi.addEventListener('click',()=>{
  if(infoSi.style.maxHeight==='0px' || !infoSi.style.maxHeight){
    infoSi.style.maxHeight=infoSi.scrollHeight+'px'; infoSi.style.padding='12px'; arrowSi.textContent='‚ñ≤';
  }else{ infoSi.style.maxHeight='0'; infoSi.style.padding='0 12px'; arrowSi.textContent='‚ñº'; }
});

/* timing for report */
let pageStart=performance.now(), timeAwayTotal=0, lastHidden=null, totalChecks=0;
document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ lastHidden=performance.now(); } else if(lastHidden){ timeAwayTotal += performance.now()-lastHidden; lastHidden=null; }});

/* ====== ACT 1 ====== */
const ENDINGS=["-√≠a","-√≠as","-√≠a","-√≠amos","-√≠ais","-√≠an"];
const PRON2END={yo:"-√≠a",tu:"-√≠as",el:"-√≠a",nosotros:"-√≠amos",vosotros:"-√≠ais",ellos:"-√≠an"};

/* ---------- Chip factory: speaks on click AND on drag ---------- */
function mkChip(txt, scopeSel){
  const chip=document.createElement('span');
  chip.className='chip';
  chip.textContent=txt;
  chip.draggable=true;

  // Speak when clicked
  chip.addEventListener('click',()=>{
    document.querySelectorAll(scopeSel+' .chip').forEach(c=>c.classList.remove('sel'));
    chip.classList.add('sel');
    speakEs(txt);
  });

  // Speak on drag start
  chip.addEventListener('dragstart',e=>{
    e.dataTransfer.setData('text/plain', txt);
    chip.classList.add('sel','dragging');
    speakEs(txt);
  });
  chip.addEventListener('dragend',()=> chip.classList.remove('sel','dragging'));

  // Keyboard: Enter/Space to speak
  chip.tabIndex=0;
  chip.addEventListener('keydown',e=>{
    if(e.key==='Enter' || e.key===' '){ e.preventDefault(); speakEs(txt); }
  });

  return chip;
}

function buildA1(){
  const bank=document.getElementById('a1Bank'); bank.innerHTML='';
  shuffle(ENDINGS).forEach(end=> bank.appendChild(mkChip(end, '#a1')));
  document.querySelectorAll('#a1 .box6 td').forEach(td=>{
    const dz=td.querySelector('.dropzone'); dz.innerHTML='';
    dz.addEventListener('dragover',e=>e.preventDefault());
    dz.addEventListener('drop',e=>{ e.preventDefault(); placeEnding(td, e.dataTransfer.getData('text/plain')); });
    dz.addEventListener('click',()=>{ const sel=document.querySelector('#a1 .chip.sel'); if(sel){ placeEnding(td, sel.textContent); sel.remove(); }});
  });
  document.getElementById('a1Score').textContent='Correctos: 0 / 6';
}
function placeEnding(td, ending){
  const dz=td.querySelector('.dropzone'); dz.innerHTML='';
  const span=mkChip(ending,'#a1');
  span.addEventListener('click',()=>{ const txt=span.textContent; span.remove(); document.getElementById('a1Bank').appendChild(mkChip(txt,'#a1')); });
  dz.appendChild(span);
}
document.getElementById('a1Check').addEventListener('click',()=>{
  totalChecks++;
  let score=0;
  document.querySelectorAll('#a1 .box6 td').forEach(td=>{
    const need=PRON2END[td.dataset.pron];
    const got=(td.querySelector('.dropzone').textContent||'').trim();
    if(got===need){ td.classList.add('flash-ok'); setTimeout(()=>td.classList.remove('flash-ok'),350); score++; }
    else { td.classList.add('flash-bad'); setTimeout(()=>td.classList.remove('flash-bad'),350);
      const txt=(td.querySelector('.dropzone').textContent||'').trim();
      if(txt){ td.querySelector('.dropzone').innerHTML=''; document.getElementById('a1Bank').appendChild(mkChip(txt,'#a1')); }
    }
  });
  document.getElementById('a1Score').textContent=`Correctos: ${score} / 6`;
});
document.getElementById('a1Reset').addEventListener('click', buildA1);

/* ====== ACT 2 ====== */
const A2_REG=["viajar√≠a","estudiar√≠as","vivir√≠amos","cuidar√≠an","protestar√≠ais","limpiar√≠a"];
const A2_IRR=["tendr√≠a","har√≠as","podr√≠an","dir√≠amos","querr√≠ais","vendr√≠an"];
function buildA2(){
  const bank=document.getElementById('a2Bank'); bank.innerHTML='';
  const all=shuffle(A2_REG.concat(A2_IRR));
  all.forEach(f=> bank.appendChild(mkChip(f,'#a2')));
  ["a2Reg","a2Irr"].forEach(id=>{
    const dz=document.getElementById(id); dz.innerHTML='';
    dz.addEventListener('dragover',e=>e.preventDefault());
    dz.addEventListener('drop',e=>{ e.preventDefault(); placeA2(dz, e.dataTransfer.getData('text/plain')); });
    dz.addEventListener('click',()=>{ const sel=document.querySelector('#a2 .chip.sel'); if(sel){ placeA2(dz, sel.textContent); sel.remove(); }});
  });
  document.getElementById('a2Score').textContent='Correctos: 0 / 12';
}
function placeA2(dz, txt){
  const chip=mkChip(txt,'#a2');
  chip.addEventListener('click',()=>{ chip.remove(); document.getElementById('a2Bank').appendChild(mkChip(txt,'#a2')); });
  dz.appendChild(chip);
}
document.getElementById('a2Check').addEventListener('click',()=>{
  totalChecks++;
  const regSel=Array.from(document.querySelectorAll('#a2Reg .chip')).map(c=>c.textContent);
  const irrSel=Array.from(document.querySelectorAll('#a2Irr .chip')).map(c=>c.textContent);
  let right=0; A2_REG.forEach(x=>{ if(regSel.includes(x)) right++; }); A2_IRR.forEach(x=>{ if(irrSel.includes(x)) right++; });
  document.getElementById('a2Score').textContent=`Correctos: ${right} / 12`;
});
document.getElementById('a2Reset').addEventListener('click', buildA2);

/* ====== ACT 3 ====== */
const A3_ITEMS=[
  {prompt:"En un mundo ideal, nosotros ______ (viajar) m√°s.", use:"hipot√©tico", ans:"viajar√≠amos"},
  {prompt:"Yo que t√∫, ______ (probar) energ√≠a solar.", use:"sugerencia", ans:"probar√≠as"},
  {prompt:"Este verano me ______ (gustar) hacer un voluntariado.", use:"deseo", ans:"gustar√≠a"},
  {prompt:"Con m√°s tiempo libre, ellos ______ (dise√±ar) soluciones nuevas.", use:"hipot√©tico", ans:"dise√±ar√≠an"},
  {prompt:"Yo que t√∫, ______ (poder) informarte en la web del municipio.", use:"sugerencia", ans:"podr√≠as"},
  {prompt:"Me ______ (encantar) trabajar como voluntario.", use:"deseo", ans:"encantar√≠a"},
  {prompt:"La ciudad ______ (ser) m√°s sostenible con paneles solares.", use:"hipot√©tico", ans:"ser√≠a"},
  {prompt:"Yo que t√∫, ______ (estudiar) inform√°tica aplicada al medioambiente.", use:"sugerencia", ans:"estudiar√≠as"}
];
const A3_USES=["hipot√©tico","sugerencia","deseo"];
function buildA3(){
  const c=document.getElementById('a3List'); c.innerHTML='';
  shuffle(A3_ITEMS).forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='q';
    row.innerHTML = `<div>${idx+1}) ${it.prompt}</div>
      <div class="small" style="margin:6px 0">
        Uso / Use:
        <select class="a3use">${A3_USES.map(x=>`<option>${x}</option>`).join('')}</select>
        &nbsp;|&nbsp;
        Forma: <input type="text" class="a3in" placeholder="condicional">
      </div>
      <div class="feedback small"></div>`;
    row.dataset.use=it.use; row.dataset.ans=it.ans;
    c.appendChild(row);
  });
}
document.getElementById('a3Check').addEventListener('click',()=>{
  totalChecks++;
  let score=0;
  document.querySelectorAll('#a3List .q').forEach(row=>{
    const use=row.querySelector('.a3use').value;
    const inp=row.querySelector('.a3in').value;
    const fb=row.querySelector('.feedback');
    const ok=(use===row.dataset.use)&&(norm(inp)===norm(row.dataset.ans));
    if(ok){ score++; row.classList.add('correct'); row.classList.remove('incorrect'); fb.innerHTML='<span class="good">‚úÖ</span>'; }
    else{ row.classList.add('incorrect'); row.classList.remove('correct'); fb.innerHTML=`<span class="bad">‚Üí Uso: ${row.dataset.use} | Forma: ${row.dataset.ans}</span>`; setTimeout(()=>{ fb.classList.add('fade-out'); setTimeout(()=>{ fb.classList.remove('fade-out'); fb.textContent=''; },650); },3000); }
  });
  document.getElementById('a3Score').textContent=`Correctos: ${score} / ${document.querySelectorAll('#a3List .q').length}`;
});
document.getElementById('a3Reset').addEventListener('click', buildA3);

/* ====== ACT 4 (build & reorder) ====== */
const A4_MODELS=[
  ["Nosotros","instalar√≠amos","paneles","solares","en","la","escuela."],
  ["La","ciudad","invertir√≠a","en","transporte","limpio."],
  ["¬øPodr√≠as","explicarme","el","plan","de","energ√≠a","renovable?"],
  ["Me","encantar√≠a","trabajar","como","voluntario."],
  ["Ellos","proteger√≠an","el","medioambiente","con","reciclaje."]
];
function buildA4(){
  const bank=document.getElementById('a4Bank'), drop=document.getElementById('a4Drop'), hint=document.getElementById('a4Hint');
  bank.innerHTML=''; drop.innerHTML=''; document.getElementById('a4Fb').textContent='';
  const model=pick(A4_MODELS).slice(); const target=model.slice();
  hint.textContent='Pista / Hint: '+target.join(' ');
  shuffle(model).forEach(w=>{
    const chip=mkChip(w,'#a4');
    chip.addEventListener('click',()=>{ moveChipToDrop(chip, drop); });
    bank.appendChild(chip);
  });

  // reorder inside drop zone
  drop.addEventListener('dragover',e=>{
    e.preventDefault();
    const dragging = document.querySelector('#a4 .chip.dragging');
    if(!dragging) return;
    const afterEl = getDropInsertTarget(drop, e.clientX, e.clientY);
    if(afterEl==null){ drop.appendChild(dragging); }
    else { drop.insertBefore(dragging, afterEl); }
  });
  drop.addEventListener('drop',e=>{ e.preventDefault(); });

  // check button
  document.getElementById('a4Check').onclick=()=>{
    totalChecks++;
    const got=[...document.querySelectorAll('#a4Drop .chip')].map(c=>c.textContent);
    const fb=document.getElementById('a4Fb');
    if(got.length===target.length && got.every((w,i)=>norm(w)===norm(target[i]))){
      fb.innerHTML='<span class="good">‚úÖ Correcto</span>';
      const sc=document.getElementById('a4Score'); const n=parseInt(sc.textContent.match(/\d+/)[0])+1; sc.textContent=`Correctos: ${n} / 5`;
      buildA4();
    }else{
      fb.innerHTML='<span class="bad">‚Üí '+target.join(' ')+'</span>';
      setTimeout(()=>{ fb.textContent=''; },3000);
    }
  };
}
function moveChipToDrop(chip, drop){
  speakEs(chip.textContent);
  chip.remove();
  const inDrop = mkChip(chip.textContent,'#a4');
  inDrop.addEventListener('click',()=>{ // remove back to bank
    const txt=inDrop.textContent;
    inDrop.remove();
    document.getElementById('a4Bank').appendChild(mkChip(txt,'#a4'));
  });
  drop.appendChild(inDrop);
}
function getDropInsertTarget(container, x, y){
  const chips=[...container.querySelectorAll('.chip:not(.dragging)')];
  return chips.find(ch=>{
    const r=ch.getBoundingClientRect();
    return y>r.top && y<r.bottom && x<r.left + r.width/2;
  }) || null;
}
document.getElementById('a4Reset').addEventListener('click', buildA4);

/* ====== ACT 5 (Si left, drop space right) ====== */
const A5_PAIRS=[
  ["Si tuviera m√°s tiempo,","viajar√≠a por Sudam√©rica."],
  ["Si hiciera sol,","ir√≠amos a la playa."],
  ["Si fueras voluntario/a,","ayudar√≠as al medioambiente."],
  ["Si la ciudad instalara paneles,","pagar√≠amos menos por la luz."],
  ["Si tuvi√©ramos un buen plan,","proteger√≠amos el ecosistema."],
  ["Si pudieran elegir,","estudiar√≠an energ√≠a sostenible."]
];

let A5_order=[];
function buildA5Rows(){
  const tbody=document.getElementById('a5Rows'); tbody.innerHTML='';
  A5_order = shuffle(A5_PAIRS.map((_,i)=>i));
  A5_order.forEach((idx,i)=>{
    const [si,res] = A5_PAIRS[idx];
    const tr=document.createElement('tr');
    const tdL=document.createElement('td'); tdL.className='a5-left';
    tdL.innerHTML = `<b>${i+1})</b> ${si}`;
    const tdR=document.createElement('td'); tdR.className='a5-right';
    tdR.innerHTML = `<div class="slot" data-index="${idx}"></div><div class="feedback small"></div>`;
    tr.appendChild(tdL); tr.appendChild(tdR);
    tbody.appendChild(tr);
  });

  document.querySelectorAll('#a5Rows .slot').forEach(s=>{
    s.addEventListener('dragover',e=>e.preventDefault());
    s.addEventListener('drop',e=>{
      e.preventDefault();
      const txt=e.dataTransfer.getData('text/plain');
      const src=document.querySelector('#a5Bank .half.sel');
      placeA5(s, txt, src);
    });
    s.addEventListener('click',()=>{ document.querySelectorAll('#a5Rows .slot').forEach(x=>x.classList.remove('sel')); s.classList.add('sel'); });
  });
}

function buildA5Bank(){
  const bank=document.getElementById('a5Bank'); bank.innerHTML='';
  shuffle(A5_PAIRS.map(p=>p[1])).forEach(res=>{
    const chip=mkChip(res,'#a5'); chip.classList.replace('chip','half');
    chip.addEventListener('click',()=>{
      const target = document.querySelector('#a5Rows .slot.sel') || Array.from(document.querySelectorAll('#a5Rows .slot')).find(s=>!s.querySelector('.half'));
      if(target){ placeA5(target, res, chip); }
    });
    bank.appendChild(chip);
  });
}

function placeA5(slot, txt, sourceChip){
  const exist=slot.querySelector('.half');
  if(exist){ returnToBank(exist.textContent); exist.remove(); }
  const chip=mkChip(txt,'#a5'); chip.classList.replace('chip','half');
  chip.addEventListener('click',()=>{ chip.remove(); returnToBank(txt); });
  slot.appendChild(chip);
  if(sourceChip && sourceChip.remove) sourceChip.remove();
}

function returnToBank(txt){
  const back=mkChip(txt,'#a5'); back.classList.replace('chip','half');
  back.addEventListener('click',()=>{
    const target = document.querySelector('#a5Rows .slot.sel') || Array.from(document.querySelectorAll('#a5Rows .slot')).find(s=>!s.querySelector('.half'));
    if(target){ placeA5(target, txt, back); }
  });
  document.getElementById('a5Bank').appendChild(back);
}

function checkA5(){
  totalChecks++;
  let score=0;
  document.querySelectorAll('#a5Rows tr').forEach((tr, i)=>{
    const slot=tr.querySelector('.slot');
    const idx=slot.dataset.index;
    const expected=A5_PAIRS[idx][1];
    const got=(slot.querySelector('.half')||{}).textContent||'';
    const fb=tr.querySelector('.feedback');
    if(norm(got)===norm(expected)){ score++; tr.classList.add('correct'); tr.classList.remove('incorrect'); fb.innerHTML='<span class="good">‚úÖ</span>'; }
    else{ tr.classList.add('incorrect'); tr.classList.remove('correct'); fb.innerHTML=`<span class="bad">‚Üí ${expected}</span>`; setTimeout(()=>{ fb.classList.add('fade-out'); setTimeout(()=>{ fb.classList.remove('fade-out'); fb.textContent=''; },650); },3000); }
  });
  document.getElementById('a5Score').textContent=`Correctos: ${score} / ${A5_PAIRS.length}`;
}

document.getElementById('a5Shuffle').addEventListener('click',()=>{ buildA5Rows(); buildA5Bank(); });
document.getElementById('a5HintBtn').addEventListener('click',()=>{
  const row = Array.from(document.querySelectorAll('#a5Rows tr')).find(r=>!r.querySelector('.slot .half')) || document.querySelector('#a5Rows tr');
  if(!row) return;
  const idx=row.querySelector('.slot').dataset.index;
  const res=A5_PAIRS[idx][1];
  const chip = Array.from(document.querySelectorAll('#a5Bank .half')).find(h=>norm(h.textContent)===norm(res));
  if(chip){ chip.classList.add('highlight'); setTimeout(()=>chip.classList.remove('highlight'),1200); }
  const wrongs = Array.from(document.querySelectorAll('#a5Bank .half')).filter(h=>norm(h.textContent)!==norm(res));
  shuffle(wrongs).slice(0,2).forEach(el=>{ el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'),400); });
});
document.getElementById('a5Reset').addEventListener('click',()=>{ buildA5Rows(); buildA5Bank(); });
document.getElementById('a5Check').addEventListener('click', checkA5);

/* ====== REPORT (.txt) ====== */
function pad2(n){ return n<10?'0'+n:n; }
function formatSeconds(s){ const m=Math.floor(s/60), r=s%60; return m+':'+pad2(r); }
function buildReport(){
  const name=(document.getElementById('studentName').value||'SinNombre').trim();
  const secs=Math.round((performance.now()-pageStart)/1000);
  const a1=document.getElementById('a1Score').textContent;
  const a2=document.getElementById('a2Score').textContent;
  const a3=document.getElementById('a3Score').textContent;
  const a4=document.getElementById('a4Score').textContent;
  const a5=document.getElementById('a5Score').textContent;
  return [
    'Student: '+name,
    'Time in activity: '+formatSeconds(secs),
    'Total checks: '+totalChecks,
    'A1 Endings sort: '+a1,
    'A2 Regular vs. Irregular: '+a2,
    'A3 Use + Form: '+a3,
    'A4 Build (order): '+a4,
    'A5 Si‚ÜíCond match: '+a5,
    'Tab-away seconds: '+Math.round(timeAwayTotal/1000)
  ].join('\r\n');
}
document.getElementById('previewBtn').addEventListener('click',()=>{ document.getElementById('reportPreview').textContent=buildReport(); });
document.getElementById('copyBtn').addEventListener('click',()=>{
  const t=buildReport();
  if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(t); alert('Copiado / Copied'); }
  else{ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Copiado / Copied'); }
});
document.getElementById('downloadReport').addEventListener('click',()=>{
  const name=(document.getElementById('studentName').value||'report').replace(/[^\w\s√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±.-]/g,'');
  const blob=new Blob([buildReport()],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=(name||'report')+'_condicional.txt';
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
});

/* ====== INIT ====== */
function initAll(){
  buildA1(); buildA2(); buildA3(); buildA4();
  buildA5Rows(); buildA5Bank();
}
initAll();
</script>
</body>
</html>
