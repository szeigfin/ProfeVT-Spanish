<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ProfeVT · Empareja el país con su mapa · v4 (per-continent check, hover labels)</title>
<style>
  :root{
    --bg:#f7fafc; --ink:#0f172a; --muted:#475569; --card:#fff; --accent:#2563eb;
    --ok:#16a34a; --bad:#dc2626; --chip:#e2e8f0; --drop:#f8fafc;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;line-height:1.45}
  header{padding:16px;background:linear-gradient(90deg,#2563eb,#22c55e);color:#fff;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header .brand{font-weight:900;letter-spacing:.3px;background:rgba(255,255,255,.15);padding:4px 10px;border-radius:999px}
  header h1{margin:0;font-size:1.1rem}
  .wrap{max-width:1200px;margin:18px auto;padding:0 12px 64px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.08);padding:14px;margin:12px 0;border:1px solid #e5e7eb}
  .dir{font-size:.95rem;color:var(--muted);border-left:4px solid var(--accent);padding-left:10px;margin:6px 0}
  h2{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .pill{display:inline-block;background:#e2e8f0;border-radius:999px;padding:.15rem .55rem;font-size:.8rem}
  .region{display:grid;grid-template-columns:2fr 1fr;gap:14px}
  @media(max-width:980px){ .region{grid-template-columns:1fr} }
  .targets{display:grid;grid-template-columns:repeat(3,minmax(180px,1fr));gap:10px}
  @media(max-width:820px){ .targets{grid-template-columns:repeat(2,minmax(160px,1fr))} }
  .target{border:2px dashed #cbd5e1;background:var(--drop);border-radius:12px;padding:10px;min-height:160px;position:relative;display:flex;flex-direction:column;gap:8px;justify-content:center;align-items:center}
  .target .map{width:100%;max-width:200px;height:120px;object-fit:contain;background:#fff;border:1px solid #e5e7eb;border-radius:8px}
  .target .slot{min-height:36px;display:flex;align-items:center;justify-content:center;border:1px dashed #cbd5e1;border-radius:8px;width:100%;padding:6px 8px;background:#fff}
  .target.ok{border-color:#86efac;background:#f0fdf4}
  .target.bad{border-color:#fecaca;background:#fff7f7}
  .side{display:flex;flex-direction:column;gap:12px}
  .bank{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap;max-height:260px;overflow:auto}
  .chip{background:var(--chip);padding:6px 10px;border-radius:999px;font-weight:700;display:flex;gap:8px;align-items:center;cursor:grab;user-select:none;border:1px solid #cbd5e1}
  .chip .flag{font-size:20px}
  .chip.selected{outline:3px solid #2563eb}
  .refcard{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
  .refwrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb;min-height:180px;background:#fff}
  .refmap{width:100%;height:auto;display:block}
  .refmap.labels{position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;transition:opacity .2s ease}
  .refwrap.loaded .refmap.labels{opacity:0}
  .refwrap.loaded:hover .refmap.labels{opacity:1}
  .refstatus{position:absolute;right:8px;bottom:8px;background:rgba(15,23,42,.7);color:#fff;padding:2px 6px;border-radius:6px;font-size:.78rem}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:8px;align-items:center}
  .ghostbtn{background:#eef2ff;border:1px solid #c7d2fe;color:#111827;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .primary{background:#2563eb;color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
  .report{background:#0f172a;color:#e5e7eb;padding:10px;border-radius:10px;white-space:pre-wrap}
  .hud{display:flex;gap:10px;flex-wrap:wrap}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .scoreline{font-size:.9rem;color:#334155}
  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:1000}
  .lightbox.open{display:flex}
  .lightbox img{max-width:92vw;max-height:92vh;border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,.45);background:#fff}
</style>
</head>
<body>
<header>
  <span class="brand">ProfeVT</span>
  <h1>Empareja el país con su mapa · v4</h1>
  <div style="margin-left:auto">
    <span style="font-size:.95rem">Nombre / Name: <input id="studentName" placeholder="Tu nombre…" style="max-width:220px"></span>
  </div>
</header>

<div class="wrap">
  <section class="card">
    <h2>Instrucciones / Directions</h2>
    <p class="dir">
      <b>ES:</b> Arrastra o haz clic en una ficha (<i>bandera + país</i>) y colócala sobre la <b>silueta</b> correcta. También puedes <b>clic en la ficha</b> y luego <b>clic en la silueta</b>. Coloca todas y luego pulsa <b>Calificar</b>. Meta: reconocer países por su mapa.<br>
      <b>EN:</b> Drag or click a token (<i>flag + country</i>) and drop it on the correct <b>outline map</b>. You can also <b>click the token</b>, then <b>click the target</b>. Place them all, then press <b>Check</b>. Goal: recognize countries by their map.
    </p>
    <p class="dir"><b>ACTFL “I can…”:</b> <i>I can identify countries by flags and map outlines; I can match geographic visuals to country names.</i></p>
    <div class="hud">
      <span class="pill">Tiempo / Time: <span id="timeOnPage">0s</span></span>
      <span class="pill">Fuera de pestaña / Tab-away: <span id="tabAway">0s</span></span>
    </div>
  </section>

  
  <section class="card region" id="region-america_del_norte" data-key="america_del_norte" data-total="5">
    <div>
      <h2>América del Norte <span class="pill" id="badge-america_del_norte">0 / 5</span></h2>
      <div class="targets" id="targets-america_del_norte"></div>
      <div class="controls">
        <span id="scoreline-america_del_norte" class="scoreline">Correctos: 0 / 5</span>
        <div>
          <button class="ghostbtn" id="reset-america_del_norte">Reiniciar</button>
          <button class="primary" id="check-america_del_norte">Calificar</button>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="bank">
        <div class="row">
          <strong>Banco de fichas / Token bank</strong>
        </div>
        <div class="chips" id="bank-america_del_norte"></div>
      </div>
      <div class="refcard">
        <div id="refwrap-america_del_norte" class="refwrap" title="Pasa el cursor para ver etiquetas / Hover to reveal labels">
          <img id="ref-base-america_del_norte" class="refmap base" alt="Mapa de referencia (bordes) América del Norte" src="">
          <img id="ref-labels-america_del_norte" class="refmap labels" alt="Mapa político (etiquetas) América del Norte" src="">
          <span id="refstatus-america_del_norte" class="refstatus">Cargando mapa…</span>
        </div>
        <div class="row">
          <span class="dir" style="border:none;padding:0;margin:0;font-size:.85rem">Bordes visibles; etiquetas al pasar el cursor.</span>
          <button class="primary" id="zoom-america_del_norte">Zoom</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card region" id="region-america_central" data-key="america_central" data-total="7">
    <div>
      <h2>América Central <span class="pill" id="badge-america_central">0 / 7</span></h2>
      <div class="targets" id="targets-america_central"></div>
      <div class="controls">
        <span id="scoreline-america_central" class="scoreline">Correctos: 0 / 7</span>
        <div>
          <button class="ghostbtn" id="reset-america_central">Reiniciar</button>
          <button class="primary" id="check-america_central">Calificar</button>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="bank">
        <div class="row">
          <strong>Banco de fichas / Token bank</strong>
        </div>
        <div class="chips" id="bank-america_central"></div>
      </div>
      <div class="refcard">
        <div id="refwrap-america_central" class="refwrap" title="Pasa el cursor para ver etiquetas / Hover to reveal labels">
          <img id="ref-base-america_central" class="refmap base" alt="Mapa de referencia (bordes) América Central" src="">
          <img id="ref-labels-america_central" class="refmap labels" alt="Mapa político (etiquetas) América Central" src="">
          <span id="refstatus-america_central" class="refstatus">Cargando mapa…</span>
        </div>
        <div class="row">
          <span class="dir" style="border:none;padding:0;margin:0;font-size:.85rem">Bordes visibles; etiquetas al pasar el cursor.</span>
          <button class="primary" id="zoom-america_central">Zoom</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card region" id="region-america_el_caribe" data-key="america_el_caribe" data-total="5">
    <div>
      <h2>América: El Caribe <span class="pill" id="badge-america_el_caribe">0 / 5</span></h2>
      <div class="targets" id="targets-america_el_caribe"></div>
      <div class="controls">
        <span id="scoreline-america_el_caribe" class="scoreline">Correctos: 0 / 5</span>
        <div>
          <button class="ghostbtn" id="reset-america_el_caribe">Reiniciar</button>
          <button class="primary" id="check-america_el_caribe">Calificar</button>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="bank">
        <div class="row">
          <strong>Banco de fichas / Token bank</strong>
        </div>
        <div class="chips" id="bank-america_el_caribe"></div>
      </div>
      <div class="refcard">
        <div id="refwrap-america_el_caribe" class="refwrap" title="Pasa el cursor para ver etiquetas / Hover to reveal labels">
          <img id="ref-base-america_el_caribe" class="refmap base" alt="Mapa de referencia (bordes) América: El Caribe" src="">
          <img id="ref-labels-america_el_caribe" class="refmap labels" alt="Mapa político (etiquetas) América: El Caribe" src="">
          <span id="refstatus-america_el_caribe" class="refstatus">Cargando mapa…</span>
        </div>
        <div class="row">
          <span class="dir" style="border:none;padding:0;margin:0;font-size:.85rem">Bordes visibles; etiquetas al pasar el cursor.</span>
          <button class="primary" id="zoom-america_el_caribe">Zoom</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card region" id="region-america_del_sur" data-key="america_del_sur" data-total="10">
    <div>
      <h2>América del Sur <span class="pill" id="badge-america_del_sur">0 / 10</span></h2>
      <div class="targets" id="targets-america_del_sur"></div>
      <div class="controls">
        <span id="scoreline-america_del_sur" class="scoreline">Correctos: 0 / 10</span>
        <div>
          <button class="ghostbtn" id="reset-america_del_sur">Reiniciar</button>
          <button class="primary" id="check-america_del_sur">Calificar</button>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="bank">
        <div class="row">
          <strong>Banco de fichas / Token bank</strong>
        </div>
        <div class="chips" id="bank-america_del_sur"></div>
      </div>
      <div class="refcard">
        <div id="refwrap-america_del_sur" class="refwrap" title="Pasa el cursor para ver etiquetas / Hover to reveal labels">
          <img id="ref-base-america_del_sur" class="refmap base" alt="Mapa de referencia (bordes) América del Sur" src="">
          <img id="ref-labels-america_del_sur" class="refmap labels" alt="Mapa político (etiquetas) América del Sur" src="">
          <span id="refstatus-america_del_sur" class="refstatus">Cargando mapa…</span>
        </div>
        <div class="row">
          <span class="dir" style="border:none;padding:0;margin:0;font-size:.85rem">Bordes visibles; etiquetas al pasar el cursor.</span>
          <button class="primary" id="zoom-america_del_sur">Zoom</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card region" id="region-europa" data-key="europa" data-total="8">
    <div>
      <h2>Europa <span class="pill" id="badge-europa">0 / 8</span></h2>
      <div class="targets" id="targets-europa"></div>
      <div class="controls">
        <span id="scoreline-europa" class="scoreline">Correctos: 0 / 8</span>
        <div>
          <button class="ghostbtn" id="reset-europa">Reiniciar</button>
          <button class="primary" id="check-europa">Calificar</button>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="bank">
        <div class="row">
          <strong>Banco de fichas / Token bank</strong>
        </div>
        <div class="chips" id="bank-europa"></div>
      </div>
      <div class="refcard">
        <div id="refwrap-europa" class="refwrap" title="Pasa el cursor para ver etiquetas / Hover to reveal labels">
          <img id="ref-base-europa" class="refmap base" alt="Mapa de referencia (bordes) Europa" src="">
          <img id="ref-labels-europa" class="refmap labels" alt="Mapa político (etiquetas) Europa" src="">
          <span id="refstatus-europa" class="refstatus">Cargando mapa…</span>
        </div>
        <div class="row">
          <span class="dir" style="border:none;padding:0;margin:0;font-size:.85rem">Bordes visibles; etiquetas al pasar el cursor.</span>
          <button class="primary" id="zoom-europa">Zoom</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card region" id="region-africa" data-key="africa" data-total="6">
    <div>
      <h2>África <span class="pill" id="badge-africa">0 / 6</span></h2>
      <div class="targets" id="targets-africa"></div>
      <div class="controls">
        <span id="scoreline-africa" class="scoreline">Correctos: 0 / 6</span>
        <div>
          <button class="ghostbtn" id="reset-africa">Reiniciar</button>
          <button class="primary" id="check-africa">Calificar</button>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="bank">
        <div class="row">
          <strong>Banco de fichas / Token bank</strong>
        </div>
        <div class="chips" id="bank-africa"></div>
      </div>
      <div class="refcard">
        <div id="refwrap-africa" class="refwrap" title="Pasa el cursor para ver etiquetas / Hover to reveal labels">
          <img id="ref-base-africa" class="refmap base" alt="Mapa de referencia (bordes) África" src="">
          <img id="ref-labels-africa" class="refmap labels" alt="Mapa político (etiquetas) África" src="">
          <span id="refstatus-africa" class="refstatus">Cargando mapa…</span>
        </div>
        <div class="row">
          <span class="dir" style="border:none;padding:0;margin:0;font-size:.85rem">Bordes visibles; etiquetas al pasar el cursor.</span>
          <button class="primary" id="zoom-africa">Zoom</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card region" id="region-asia" data-key="asia" data-total="6">
    <div>
      <h2>Asia <span class="pill" id="badge-asia">0 / 6</span></h2>
      <div class="targets" id="targets-asia"></div>
      <div class="controls">
        <span id="scoreline-asia" class="scoreline">Correctos: 0 / 6</span>
        <div>
          <button class="ghostbtn" id="reset-asia">Reiniciar</button>
          <button class="primary" id="check-asia">Calificar</button>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="bank">
        <div class="row">
          <strong>Banco de fichas / Token bank</strong>
        </div>
        <div class="chips" id="bank-asia"></div>
      </div>
      <div class="refcard">
        <div id="refwrap-asia" class="refwrap" title="Pasa el cursor para ver etiquetas / Hover to reveal labels">
          <img id="ref-base-asia" class="refmap base" alt="Mapa de referencia (bordes) Asia" src="">
          <img id="ref-labels-asia" class="refmap labels" alt="Mapa político (etiquetas) Asia" src="">
          <span id="refstatus-asia" class="refstatus">Cargando mapa…</span>
        </div>
        <div class="row">
          <span class="dir" style="border:none;padding:0;margin:0;font-size:.85rem">Bordes visibles; etiquetas al pasar el cursor.</span>
          <button class="primary" id="zoom-asia">Zoom</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card region" id="region-oceania" data-key="oceania" data-total="3">
    <div>
      <h2>Oceanía <span class="pill" id="badge-oceania">0 / 3</span></h2>
      <div class="targets" id="targets-oceania"></div>
      <div class="controls">
        <span id="scoreline-oceania" class="scoreline">Correctos: 0 / 3</span>
        <div>
          <button class="ghostbtn" id="reset-oceania">Reiniciar</button>
          <button class="primary" id="check-oceania">Calificar</button>
        </div>
      </div>
    </div>
    <div class="side">
      <div class="bank">
        <div class="row">
          <strong>Banco de fichas / Token bank</strong>
        </div>
        <div class="chips" id="bank-oceania"></div>
      </div>
      <div class="refcard">
        <div id="refwrap-oceania" class="refwrap" title="Pasa el cursor para ver etiquetas / Hover to reveal labels">
          <img id="ref-base-oceania" class="refmap base" alt="Mapa de referencia (bordes) Oceanía" src="">
          <img id="ref-labels-oceania" class="refmap labels" alt="Mapa político (etiquetas) Oceanía" src="">
          <span id="refstatus-oceania" class="refstatus">Cargando mapa…</span>
        </div>
        <div class="row">
          <span class="dir" style="border:none;padding:0;margin:0;font-size:.85rem">Bordes visibles; etiquetas al pasar el cursor.</span>
          <button class="primary" id="zoom-oceania">Zoom</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Informe / Report (plain text)</h2>
    <pre id="reportPreview" class="report">— Pulsa “Actualizar vista previa” —</pre>
    <div class="row" style="justify-content:flex-end">
      <button class="ghostbtn" id="previewBtn">Actualizar vista previa</button>
      <button class="ghostbtn" id="copyBtn">Copiar</button>
      <button class="primary" id="downloadReport">Descargar (.txt)</button>
    </div>
  </section>
</div>

<div class="lightbox" id="lightbox" role="dialog" aria-label="Mapa ampliado" tabindex="-1">
  <img id="lightboxImg" alt="Mapa ampliado" src="">
</div>

<script>
var REGIONS = [{"key": "america_del_norte", "title": "América del Norte", "ref_border": "Blank_map_of_North_America.svg", "ref_labels_candidates": ["North_America_political_map_en.svg", "North_america_blank_political_map.svg", "North_America_political_map-es.svg"], "items": [{"name": "Canadá", "flag": "🇨🇦", "file": "Canada_blank_map.svg"}, {"name": "Estados Unidos", "flag": "🇺🇸", "file": "Blank_US_Map,_Mainland_with_no_States.svg"}, {"name": "México", "flag": "🇲🇽", "file": "Blank_Mexico_map,_no_States.svg"}, {"name": "Groenlandia", "flag": "🇬🇱", "file": "Greenland_location_map.svg"}, {"name": "Bermudas", "flag": "🇧🇲", "file": "Bermuda_location_map.svg"}]}, {"key": "america_central", "title": "América Central", "ref_border": "Central_America_location_map.svg", "ref_labels_candidates": ["Central_America_political_map_es.svg", "Central_America_political_map_en.svg"], "items": [{"name": "Costa Rica", "flag": "🇨🇷", "file": "Costa_Rica_location_map.svg"}, {"name": "Guatemala", "flag": "🇬🇹", "file": "Guatemala_blank.svg"}, {"name": "Honduras", "flag": "🇭🇳", "file": "Honduras_blank_map.svg"}, {"name": "Nicaragua", "flag": "🇳🇮", "file": "Map_of_Nicaragua.svg"}, {"name": "Panamá", "flag": "🇵🇦", "file": "Panama_location_map.svg"}, {"name": "El Salvador", "flag": "🇸🇻", "file": "El_Salvador_location_map.svg"}, {"name": "Belice", "flag": "🇧🇿", "file": "Belize_location_map.svg"}]}, {"key": "america_el_caribe", "title": "América: El Caribe", "ref_border": "Caribbean_general_map.svg", "ref_labels_candidates": ["Caribbean_political_map-es.svg", "Caribbean_political_map-en.svg"], "items": [{"name": "Cuba", "flag": "🇨🇺", "file": "Cuba_location_map.svg"}, {"name": "República Dominicana", "flag": "🇩🇴", "file": "Dominican_Republic_location_map.svg"}, {"name": "Puerto Rico", "flag": "🇵🇷", "file": "Puerto-Rico-blank.svg"}, {"name": "Jamaica", "flag": "🇯🇲", "file": "Jamaica_location_map.svg"}, {"name": "Haití", "flag": "🇭🇹", "file": "Haiti_location_map.svg"}]}, {"key": "america_del_sur", "title": "América del Sur", "ref_border": "South_America_-_Geographical_map_with_borders.svg", "ref_labels_candidates": ["South_America_political_map-es.svg", "South_America_political_map-en.svg", "South_America_-_Political_map_(Spanish).svg"], "items": [{"name": "Argentina", "flag": "🇦🇷", "file": "Argentina_blank.svg"}, {"name": "Bolivia", "flag": "🇧🇴", "file": "Bolivia_location_map.svg"}, {"name": "Chile", "flag": "🇨🇱", "file": "Chile_blank_map.svg"}, {"name": "Colombia", "flag": "🇨🇴", "file": "Colombia_continental_location_map.svg"}, {"name": "Ecuador", "flag": "🇪🇨", "file": "Ecuador_location_map.svg"}, {"name": "Perú", "flag": "🇵🇪", "file": "Blank_map_of_Peru.svg"}, {"name": "Paraguay", "flag": "🇵🇾", "file": "Paraguay_location_map.svg"}, {"name": "Uruguay", "flag": "🇺🇾", "file": "Uruguay_location_map.svg"}, {"name": "Venezuela", "flag": "🇻🇪", "file": "Venezuela_location_map.svg"}, {"name": "Brasil", "flag": "🇧🇷", "file": "Brazil_location_map.svg"}]}, {"key": "europa", "title": "Europa", "ref_border": "Blank_map_of_Europe.svg", "ref_labels_candidates": ["Europe_political_map-en.svg", "Europe_political_map_es.svg"], "items": [{"name": "España", "flag": "🇪🇸", "file": "Provinces_of_Spain_-_blank_map.svg"}, {"name": "Francia", "flag": "🇫🇷", "file": "France_location_map.svg"}, {"name": "Italia", "flag": "🇮🇹", "file": "Italy_location_map.svg"}, {"name": "Alemania", "flag": "🇩🇪", "file": "Germany_location_map.svg"}, {"name": "Reino Unido", "flag": "🇬🇧", "file": "United_Kingdom_location_map.svg"}, {"name": "Irlanda", "flag": "🇮🇪", "file": "Ireland_blank_map.svg"}, {"name": "Polonia", "flag": "🇵🇱", "file": "Poland_location_map.svg"}, {"name": "Rusia", "flag": "🇷🇺", "file": "Russia_blank_map.svg"}]}, {"key": "africa", "title": "África", "ref_border": "Blank_Map-Africa.svg", "ref_labels_candidates": ["Africa_political_map-en.svg", "Africa_blank_political_map.svg"], "items": [{"name": "Guinea Ecuatorial", "flag": "🇬🇶", "file": "Equatorial_Guinea_location_map.svg"}, {"name": "Nigeria", "flag": "🇳🇬", "file": "Nigeria_location_map.svg"}, {"name": "Somalia", "flag": "🇸🇴", "file": "Somalia_location_map.svg"}, {"name": "Tanzania", "flag": "🇹🇿", "file": "Tanzania_location_map.svg"}, {"name": "Kenia", "flag": "🇰🇪", "file": "Kenya_location_map.svg"}, {"name": "Burundi", "flag": "🇧🇮", "file": "Burundi_location_map.svg"}]}, {"key": "asia", "title": "Asia", "ref_border": "Blank_map_of_Asia.svg", "ref_labels_candidates": ["Asia_political_map-en.svg", "Asia_political_map_es.svg"], "items": [{"name": "China", "flag": "🇨🇳", "file": "China_blank_map.svg"}, {"name": "Japón", "flag": "🇯🇵", "file": "Japan_blank_map.svg"}, {"name": "India", "flag": "🇮🇳", "file": "India_blank_map.svg"}, {"name": "Vietnam", "flag": "🇻🇳", "file": "Vietnam_location_map.svg"}, {"name": "Nepal", "flag": "🇳🇵", "file": "Nepal_location_map.svg"}, {"name": "Corea del Sur", "flag": "🇰🇷", "file": "South_Korea_location_map.svg"}]}, {"key": "oceania", "title": "Oceanía", "ref_border": "Blank_map_of_Oceania.svg", "ref_labels_candidates": ["Oceania_political_map_en.png", "Oceania_Oceanian_countries_map.png"], "items": [{"name": "Australia", "flag": "🇦🇺", "file": "Australia_blank_map.svg"}, {"name": "Nueva Zelanda", "flag": "🇳🇿", "file": "New_Zealand_blank_map.svg"}, {"name": "Fiyi", "flag": "🇫🇯", "file": "Fiji_location_map.svg"}]}];

function commonsPath(filename){ return "https://commons.wikimedia.org/wiki/Special:FilePath/"+filename; }
function shuffle(a){ var x=a.slice(); for(var i=x.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=x[i]; x[i]=x[j]; x[j]=t;} return x; }

var pageStart = performance.now();
var timeAwayTotal = 0, lastHiddenAt = null;
var attemptsTotal = 0;
var incorrectAttempts = 0;

document.addEventListener("visibilitychange", function(){
  if(document.hidden){ lastHiddenAt = performance.now(); }
  else if(lastHiddenAt){ timeAwayTotal += (performance.now()-lastHiddenAt); lastHiddenAt = null; }
});
setInterval(function(){
  var sec = Math.round((performance.now()-pageStart)/1000);
  var t=document.getElementById("timeOnPage"); if(t) t.textContent=sec+"s";
  var ta=document.getElementById("tabAway"); if(ta) ta.textContent=Math.round(timeAwayTotal/1000)+"s";
}, 500);

var selectedChip = null;

function build(){
  for (var k=0;k<REGIONS.length;k++){
    var r = REGIONS[k];
    var grid = document.getElementById('targets-'+r.key);
    var bank = document.getElementById('bank-'+r.key);
    var wrap = document.getElementById('refwrap-'+r.key);
    var base = document.getElementById('ref-base-'+r.key);
    var labels = document.getElementById('ref-labels-'+r.key);
    var status = document.getElementById('refstatus-'+r.key);
    var zoomBtn = document.getElementById('zoom-'+r.key);
    var checkBtn = document.getElementById('check-'+r.key);
    var resetBtn = document.getElementById('reset-'+r.key);
    var scoreLine = document.getElementById('scoreline-'+r.key);
    grid.innerHTML=''; bank.innerHTML='';
    // show base borders map
    base.src = commonsPath(r.ref_border);
    base.onerror = function(){ this.style.opacity=.3; };
    // Try labeled candidates with graceful fallback
    var cand = r.ref_labels_candidates || [];
    var idx = 0; var loaded = false;
    function tryNext(){
      if(idx >= cand.length){ status.textContent = "Bordes (sin etiquetas)"; wrap.classList.add('loaded'); return; }
      var fn = cand[idx++];
      labels.onload = function(){ status.textContent = "Pasa el cursor: etiquetas"; wrap.classList.add('loaded'); loaded = true; };
      labels.onerror = function(){ labels.removeAttribute('src'); tryNext(); };
      labels.src = commonsPath(fn);
    }
    tryNext();
    zoomBtn.onclick = function(){
      var src = (loaded && labels && labels.src) ? labels.src : base.src;
      openLightbox(src);
    };
    // Targets
    var shuffledTargets = shuffle(r.items);
    for (var i=0;i<shuffledTargets.length;i++){
      (function(it){
        var t=document.createElement('div'); t.className='target'; t.setAttribute('data-expect', it.name);
        t.innerHTML = '<img class="map" alt="outline '+it.name+'" src="'+commonsPath(it.file)+'" onerror="this.style.opacity=.25" />'
                     + '<div class="slot" data-slot="'+it.name+'">Suelta aquí</div>';
        t.addEventListener('dragover', function(e){ e.preventDefault(); });
        t.addEventListener('drop', function(e){ e.preventDefault(); if(selectedChip){ placeChipOnTarget(selectedChip, t, false); }});
        t.addEventListener('click', function(){ if(selectedChip){ placeChipOnTarget(selectedChip, t, false); } });
        grid.appendChild(t);
      })(shuffledTargets[i]);
    }
    // Chips
    var shuffledChips = shuffle(r.items);
    for (var j=0;j<shuffledChips.length;j++){
      (function(it){
        var c=document.createElement('div'); c.className='chip'; c.draggable=true; c.setAttribute('data-name', it.name);
        c.innerHTML = '<span class="flag">'+it.flag+'</span> '+it.name;
        c.addEventListener('dragstart', function(e){ selectedChip=c; c.classList.add('selected'); e.dataTransfer.setData('text/plain', it.name); });
        c.addEventListener('click', function(){
          if(selectedChip===c){ c.classList.remove('selected'); selectedChip=null; }
          else { if(selectedChip){ selectedChip.classList.remove('selected'); } selectedChip=c; c.classList.add('selected'); }
        });
        bank.appendChild(c);
      })(shuffledChips[j]);
    }
    // Region check/reset logic
    checkBtn.onclick = function(){
      var regionEl = document.getElementById('region-'+r.key);
      var targets = regionEl.querySelectorAll('.target');
      var correct=0, total=targets.length;
      targets.forEach(function(t){
        var slot=t.querySelector('.slot');
        var filled = slot.getAttribute('data-filled')==='1';
        var expect = t.getAttribute('data-expect');
        var text = slot.textContent || '';
        if(filled && text.includes(expect)){ // already matched by name
          t.classList.add('ok'); t.classList.remove('bad'); correct++;
        }else{
          // if something wrong or empty, mark red and reset slot
          if(filled){ incorrectAttempts++; }
          t.classList.add('bad'); t.classList.remove('ok');
          slot.textContent='Suelta aquí'; slot.removeAttribute('data-filled');
        }
      });
      // Move any chips that were "consumed" but incorrect back has already been handled above via slot reset;
      // bank chips remain available.
      attemptsTotal++;
      scoreLine.textContent = "Correctos: "+correct+" / "+total;
      updateRegionBadge(regionEl);
      setTimeout(function(){ targets.forEach(function(t){ t.classList.remove('bad'); }); }, 700);
    };
    resetBtn.onclick = function(){ resetRegion(r.key); scoreLine.textContent="Correctos: 0 / "+r.items.length; };
  }
}

function updateRegionBadge(regionEl){
  var key = regionEl.getAttribute('data-key');
  var total = +regionEl.getAttribute('data-total') || 0;
  var filled = regionEl.querySelectorAll('.slot[data-filled="1"]').length;
  var badge = document.getElementById('badge-'+key);
  if(badge) badge.textContent = filled+" / "+total;
}

function placeChipOnTarget(chip, target, immediateCheck){
  var expect = target.getAttribute('data-expect');
  var got = chip.getAttribute('data-name');
  var slot = target.querySelector('.slot');
  // prevent double-fill
  if(slot && slot.getAttribute('data-filled')==='1'){
    flash(target,'bad'); return;
  }
  // place without grading yet
  slot.textContent = chip.textContent;
  slot.setAttribute('data-filled','1');
  chip.parentNode.removeChild(chip);
  selectedChip=null;
  updateRegionBadge(target.closest('.region'));
  if(immediateCheck){
    // (not used in v4; keeping for compatibility)
    if(expect===got){ flash(target,'ok'); }
    else { flash(target,'bad'); incorrectAttempts++; slot.textContent='Suelta aquí'; slot.removeAttribute('data-filled'); }
  }
}

function flash(el, cls){ el.classList.add(cls); setTimeout(function(){ el.classList.remove(cls); }, 600); }

function resetRegion(key){
  var regionEl = document.getElementById('region-'+key);
  var slots = regionEl.querySelectorAll('.slot');
  slots.forEach(function(s){ s.textContent='Suelta aquí'; s.removeAttribute('data-filled'); });
  // rebuild chips
  var bank = document.getElementById('bank-'+key);
  bank.innerHTML='';
  var data = null;
  for (var i=0;i<REGIONS.length;i++){ if(REGIONS[i].key===key){ data=REGIONS[i]; break; } }
  if(!data) return;
  var shuffled = shuffle(data.items);
  shuffled.forEach(function(it){
    var c=document.createElement('div'); c.className='chip'; c.draggable=true; c.setAttribute('data-name', it.name);
    c.innerHTML = '<span class="flag">'+it.flag+'</span> '+it.name;
    c.addEventListener('dragstart', function(e){ selectedChip=c; c.classList.add('selected'); e.dataTransfer.setData('text/plain', it.name); });
    c.addEventListener('click', function(){
      if(selectedChip===c){ c.classList.remove('selected'); selectedChip=null; }
      else { if(selectedChip){ selectedChip.classList.remove('selected'); } selectedChip=c; c.classList.add('selected'); }
    });
    bank.appendChild(c);
  });
  var badge = document.getElementById('badge-'+key);
  if(badge) badge.textContent = "0 / "+slots.length;
}

function formatSeconds(s){ var m=Math.floor(s/60), r=(s%60); return m+":"+(r<10?"0":"")+r; }
function buildReportText(){
  var name = (document.getElementById("studentName").value || "SinNombre").trim();
  var secs = Math.round((performance.now()-pageStart)/1000);
  var total=0, correctPlaced=0;
  for (var i=0;i<REGIONS.length;i++){
    var r = REGIONS[i];
    var regionEl = document.getElementById('region-'+r.key);
    var totalSlots = r.items.length;
    var placed = regionEl.querySelectorAll('.slot[data-filled="1"]').length;
    total += totalSlots; correctPlaced += placed;
  }
  var lines = [
    "Student: "+name,
    "Time in activity: "+formatSeconds(secs),
    "Total attempts (checks): "+attemptsTotal,
    "Incorrect attempts (mismatches): "+incorrectAttempts,
    "Currently placed (pre-check): "+correctPlaced+" / "+total
  ];
  return lines.join("\r\n");
}
function refreshPreview(){ var el=document.getElementById("reportPreview"); if(el) el.textContent = buildReportText(); }
function copyReport(){
  var txt = buildReportText();
  if (navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(function(){ alert("Copied"); }).catch(function(){
      var ta = document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); alert("Copied"); }catch(e){} document.body.removeChild(ta);
    });
  }else{
    var ta = document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); alert("Copied"); }catch(e){} document.body.removeChild(ta);
  }
}
function downloadReport(){
  var name = (document.getElementById("studentName").value || "SinNombre").trim().replace(/[^\w\sÁÉÍÓÚÜÑáéíóúüñ.-]/g,"");
  var txt = buildReportText();
  var blob = new Blob([txt],{type:"text/plain;charset=utf-8"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a"); a.href=url; a.download=(name||"report")+"_Act_MapMatch_v4.txt";
  document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); },0);
}

/* Lightbox */
function openLightbox(src){
  var lb = document.getElementById('lightbox');
  var img = document.getElementById('lightboxImg');
  if(!src){ return; }
  img.src = src;
  lb.classList.add('open');
  lb.focus();
}
document.getElementById('lightbox').addEventListener('click', function(e){
  if(e.target.id==='lightbox' || e.target.id==='lightboxImg'){ this.classList.remove('open'); }
});
document.addEventListener('keydown', function(e){
  if(e.key==='Escape'){ var lb=document.getElementById('lightbox'); lb.classList.remove('open'); }
});

document.addEventListener('DOMContentLoaded', function(){
  build();
  // Wire global buttons
  document.getElementById("previewBtn").addEventListener("click", refreshPreview);
  document.getElementById("copyBtn").addEventListener("click", copyReport);
  document.getElementById("downloadReport").addEventListener("click", downloadReport);
  setTimeout(refreshPreview, 500);
});
</script>
</body>
</html>
