<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Si + Futuro — Taller Interactivo (Unidad: Medioambiente)</title>
<style>
  :root{
    --bg:#f7fafc;
    --card:#ffffff;
    --ink:#1a202c;
    --muted:#4a5568;
    --accent:#0ea5e9;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#dc2626;
    --chip:#e2e8f0;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;line-height:1.4}
  header{padding:18px 16px;background:linear-gradient(90deg,#0ea5e9, #22c55e);color:white}
  header h1{margin:0;font-size:1.25rem}
  header p{margin:.25rem 0 0;opacity:.95}
  .wrap{max-width:980px;margin:20px auto;padding:0 12px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.07);padding:16px;margin:16px 0}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1 1 340px}
  label{font-weight:600}
  input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cbd5e1;font-size:16px}
  button{border:0;background:var(--accent);color:white;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
  button.ghost{background:#e2e8f0;color:#111827}
  button.ok{background:var(--ok)}
  button.warn{background:var(--warn)}
  .stage{border-left:6px solid var(--accent);padding-left:12px;margin-top:10px}
  .stage h2{margin:.2rem 0 .6rem;font-size:1.1rem}
  .muted{color:var(--muted);font-size:.95rem}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{background:var(--chip);padding:6px 10px;border-radius:999px;font-weight:600;cursor:grab;user-select:none}
  .drop{min-height:48px;padding:8px;border:2px dashed #cbd5e1;border-radius:10px;background:#f8fafc;margin:6px 0;display:flex;gap:8px;flex-wrap:wrap}
  .tile{padding:8px 10px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:10px;cursor:grab;user-select:none}
  .q{margin:10px 0;padding:12px;border:1px solid #e5e7eb;border-radius:12px}
  .q.correct{border-color:#86efac;background:#f0fdf4}
  .q.incorrect{border-color:#fecaca;background:#fff7f7}
  .answer{display:inline-block;min-width:140px}
  .key{display:none;margin-top:6px;font-size:.9rem;color:#2563eb}
  .score{font-weight:800}
  .foot{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .small{font-size:.85rem}
  details summary{cursor:pointer;font-weight:700}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-bottom-width:3px;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<header>
  <h1>Si + Futuro — Taller Interactivo (Unidad: Medioambiente)</h1>
  <p>Nombre: <input id="studentName" type="text" placeholder="Escribe tu nombre..." style="max-width:320px;margin-left:8px" /></p>
</header>

<div class="wrap">

  <div class="card">
    <div class="row">
      <div class="col">
        <p class="muted">
          Instrucciones: Completa las <strong>tres etapas</strong>. Este taller practica <strong>oraciones condicionales con si</strong> y el <strong>futuro</strong> dentro del tema del <em>medioambiente</em>.
        </p>
      </div>
      <div class="col">
        <div class="foot small">
          <button id="checkAll" class="ok">Calificar todo</button>
          <button id="resetAll" class="ghost">Reiniciar</button>
          <button id="exportCSV" class="warn">Descargar resultados (.csv)</button>
          <span class="small">Puntaje total: <span id="totalScore" class="score">0</span> / <span id="totalMax">0</span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- STAGE 1: Drag-and-drop ordering -->
  <div class="card stage" id="stage1">
    <h2>Etapa 1 — Ordena las partes para formar oraciones correctas</h2>
    <p class="muted">Arrastra las piezas al área de respuesta. Tema: acciones para cuidar el planeta + “si” + futuro.</p>
    <div id="s1Container"></div>
    <div class="foot small">
      <button class="ok" onclick="gradeStage(1)">Calificar Etapa 1</button>
      <span>Puntaje: <span id="s1Score" class="score">0</span> / <span id="s1Max">0</span></span>
    </div>
  </div>

  <!-- STAGE 2: Cloze -->
  <div class="card stage" id="stage2">
    <h2>Etapa 2 — Completa las oraciones (cloze)</h2>
    <p class="muted">Escribe la forma correcta (mayoría en <strong>futuro</strong>). Usa tildes cuando corresponda.</p>
    <div id="s2Container"></div>
    <div class="foot small">
      <button class="ok" onclick="gradeStage(2)">Calificar Etapa 2</button>
      <span>Puntaje: <span id="s2Score" class="score">0</span> / <span id="s2Max">0</span></span>
    </div>
  </div>

  <!-- STAGE 3: Si-clause + main infinitive -> future -->
  <div class="card stage" id="stage3">
    <h2>Etapa 3 — Conjuga en futuro la segunda parte</h2>
    <p class="muted">Te damos la cláusula con <strong>si</strong> y el verbo principal en infinitivo. Escribe <em>solo la forma correcta en futuro</em> que completa la idea lógicamente.</p>
    <div id="s3Container"></div>
    <div class="foot small">
      <button class="ok" onclick="gradeStage(3)">Calificar Etapa 3</button>
      <span>Puntaje: <span id="s3Score" class="score">0</span> / <span id="s3Max">0</span></span>
    </div>
  </div>

  <div class="card">
    <details>
      <summary>Ayuda rápida para el futuro</summary>
      <div class="small">
        <p><strong>Futuro regular:</strong> infinitivo + <code>-é, -ás, -á, -emos, -éis, -án</code></p>
        <p><strong>Irregulares comunes:</strong> tener→tendr-, poner→pondr-, poder→podr-, querer→querr-, saber→sabr-, decir→dir-, hacer→har-, salir→saldr-, venir→vendr-, haber→habr-</p>
        <p>Ej.: Si reciclas más, <em>el planeta</em> <span class="kbd">estará</span> más limpio.</p>
      </div>
    </details>
  </div>

</div>

<script>
/* ---------- Utilities ---------- */
const teacherMode = new URLSearchParams(location.search).get('teacher') === '1';

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function stripAccents(s){
  return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'')
}

function norm(s){
  return stripAccents(String(s||'').trim().toLowerCase().replace(/\s+/g,' '));
}

/* ---------- Stage 1 data (ordering) ---------- */
const S1_ITEMS = [
  // Each item: correct ordered tiles (array of strings)
  ["Si","reciclamos","más","el","plástico,","el","océano","estará","más","limpio."],
  ["Si","plantas","árboles,","la","ciudad","tendrá","más","sombra","y","oxígeno."],
  ["Si","ahorramos","energía,","bajará","la","contaminación","del","aire."],
  ["Si","usas","el","transporte","público,","protegerás","el","medioambiente."],
  ["Si","separamos","la","basura,","reduciremos","los","residuos","en","el","vertedero."],
  ["Si","cerramos","el","grifo,","ahorraremos","agua","potable."],
  ["Si","apoyan","energías","renovables,","las","ciudades","serán","más","sostenibles."],
  ["Si","limpiamos","las","playas,","los","animales","marinos","vivirán","con","menos","peligro."]
];

/* ---------- Stage 2 data (cloze) ---------- */
// Each item is an object with text parts and answers. Use ___ for blanks.
const S2_ITEMS = [
  { text:"Si reutilizas las bolsas, el consumo de plástico ___ (bajar) en la escuela.", answers:["bajará"] },
  { text:"Si la gente ___ (cuidar) los ríos, habrá más agua limpia.", answers:["cuida","cuidará"] },
  { text:"Si hoy reciclamos vidrio, mañana ___ (tener) menos basura.", answers:["tendremos"] },
  { text:"Si el gobierno invierte, las zonas verdes ___ (crecer).", answers:["crecerán"] },
  { text:"Si ponemos en peligro los bosques, los animales ___ (sufrir).", answers:["sufrirán"] },
  { text:"Si tú te relajas en el parque, ___ (sentirse) libre.", answers:["te sentirás"] },
  { text:"Si ellos escuchan la radio escolar, ___ (saber) más sobre el club ecológico.", answers:["sabrán"] },
  { text:"Si ahorras electricidad, la factura ___ (ser) más baja.", answers:["será"] }
];

/* ---------- Stage 3 data (si-clause + main infinitive to future form) ---------- */
// Prompt shows a si-clause, plus main clause infinitive and an object; student types only the conjugated future verb.
const S3_ITEMS = [
  { prompt:"Si dejamos de usar pajitas de plástico, (estar) el océano más limpio.", answer:"estará" },
  { prompt:"Si camináis a la escuela, (reducir) el tráfico en la mañana.", answer:"reduciréis" },
  { prompt:"Si la comunidad recicla más, (haber) menos residuos en el vertedero.", answer:"habrá" },
  { prompt:"Si instalan paneles solares, (pagar) menos por la electricidad.", answer:"pagarán" },
  { prompt:"Si yo traigo mi botella reutilizable, (beber) más agua durante el día.", answer:"beberé" },
  { prompt:"Si ellos protegen los humedales, (venir) más aves en primavera.", answer:"vendrán" },
  { prompt:"Si ahorramos energía en casa, (poder) viajar más este verano.", answer:"podremos" },
  { prompt:"Si tú separas la basura, (poner) cada material en su contenedor.", answer:"pondrás" }
];

/* ---------- Build Stage 1 UI ---------- */
function buildStage1(){
  const c = document.getElementById('s1Container');
  c.innerHTML='';
  const max = S1_ITEMS.length;
  document.getElementById('s1Max').textContent=max;
  S1_ITEMS.forEach((tiles, idx)=>{
    const q = document.createElement('div');
    q.className='q';
    q.dataset.index = idx;
    const h = document.createElement('div');
    h.innerHTML = `<strong>${idx+1}.</strong> Arrastra las piezas en orden:`;
    q.appendChild(h);

    // bank
    const bank = document.createElement('div');
    bank.className='chips';
    const shuffled = shuffle(tiles);
    shuffled.forEach((t,i)=>{
      const el = document.createElement('span');
      el.className='tile';
      el.textContent=t;
      el.draggable=true;
      el.dataset.source='bank';
      el.addEventListener('dragstart', dragStart);
      bank.appendChild(el);
    });
    q.appendChild(bank);

    // drop zone
    const drop = document.createElement('div');
    drop.className='drop';
    drop.addEventListener('dragover', dragOver);
    drop.addEventListener('drop', dropped);
    q.appendChild(drop);

    // answer key
    const key = document.createElement('div');
    key.className='key';
    key.textContent = 'Solución: ' + tiles.join(' ');
    q.appendChild(key);

    c.appendChild(q);
  });
}

/* Drag and Drop handlers */
let dragEl = null;
function dragStart(e){ dragEl = e.target; e.dataTransfer.setData('text/plain', dragEl.textContent); }
function dragOver(e){ e.preventDefault(); }
function dropped(e){
  e.preventDefault();
  const zone = e.currentTarget;
  if(dragEl){
    zone.appendChild(dragEl);
  }
}

/* ---------- Build Stage 2 UI ---------- */
function buildStage2(){
  const c = document.getElementById('s2Container');
  c.innerHTML='';
  document.getElementById('s2Max').textContent=S2_ITEMS.length;
  S2_ITEMS.forEach((item, idx)=>{
    const q = document.createElement('div');
    q.className='q';
    q.dataset.index = idx;
    // Render text with a single input where ___ would be; default at end if no marker.
    let parts = item.text.split('___');
    let html = `<strong>${idx+1}.</strong> ` + parts[0] + ` <input type="text" class="s2in" data-idx="${idx}" placeholder="respuesta" /> ` + (parts[1] || '');
    q.innerHTML = html;
    const key = document.createElement('div');
    key.className='key';
    key.textContent='Solución: ' + item.answers.join(' / ');
    q.appendChild(key);
    c.appendChild(q);
  });
}

/* ---------- Build Stage 3 UI ---------- */
function buildStage3(){
  const c = document.getElementById('s3Container');
  c.innerHTML='';
  document.getElementById('s3Max').textContent=S3_ITEMS.length;
  S3_ITEMS.forEach((item, idx)=>{
    const q = document.createElement('div');
    q.className='q';
    q.dataset.index = idx;
    q.innerHTML = `<strong>${idx+1}.</strong> ${item.prompt.replace(/\(.*?\)/,'<span class="muted">(verbo)</span>')}<br>
      Escribe solo la forma en <em>futuro</em> para el verbo indicado: 
      <input type="text" class="s3in" data-idx="${idx}" placeholder="forma en futuro" />`;
    const key = document.createElement('div');
    key.className='key';
    key.textContent = 'Solución: ' + item.answer;
    q.appendChild(key);
    c.appendChild(q);
  });
}

/* ---------- Teacher mode (show keys) ---------- */
function applyTeacherMode(){
  if(teacherMode){
    document.querySelectorAll('.key').forEach(k=>k.style.display='block');
  }
}

/* ---------- Grading ---------- */
function gradeStage(n){
  let score=0, max=0;
  if(n===1){
    document.querySelectorAll('#s1Container .q').forEach((q, i)=>{
      const idx = +q.dataset.index;
      const expected = S1_ITEMS[idx];
      const got = Array.from(q.querySelectorAll('.drop .tile')).map(t=>t.textContent.trim());
      max += 1;
      if (expected.length === got.length && expected.every((w,j)=> w===got[j])){
        score += 1;
        q.classList.add('correct'); q.classList.remove('incorrect');
      } else {
        q.classList.add('incorrect'); q.classList.remove('correct');
      }
    });
    document.getElementById('s1Score').textContent=score;
  }
  if(n===2){
    const inputs = document.querySelectorAll('.s2in');
    max = S2_ITEMS.length;
    inputs.forEach(inp=>{
      const idx = +inp.dataset.idx;
      const answers = S2_ITEMS[idx].answers.map(a=>norm(a));
      const val = norm(inp.value);
      const q = inp.closest('.q');
      if(answers.includes(val)){
        score++;
        q.classList.add('correct'); q.classList.remove('incorrect');
      }else{
        q.classList.add('incorrect'); q.classList.remove('correct');
      }
    });
    document.getElementById('s2Score').textContent=score;
  }
  if(n===3){
    const inputs = document.querySelectorAll('.s3in');
    max = S3_ITEMS.length;
    inputs.forEach(inp=>{
      const idx = +inp.dataset.idx;
      const expected = norm(S3_ITEMS[idx].answer);
      const val = norm(inp.value);
      const q = inp.closest('.q');
      if(val === expected){
        score++;
        q.classList.add('correct'); q.classList.remove('incorrect');
      }else{
        q.classList.add('incorrect'); q.classList.remove('correct');
      }
    });
    document.getElementById('s3Score').textContent=score;
  }
  updateTotal();
  persistState();
}

function updateTotal(){
  const s1 = +document.getElementById('s1Score').textContent || 0;
  const s2 = +document.getElementById('s2Score').textContent || 0;
  const s3 = +document.getElementById('s3Score').textContent || 0;
  const m1 = +document.getElementById('s1Max').textContent || 0;
  const m2 = +document.getElementById('s2Max').textContent || 0;
  const m3 = +document.getElementById('s3Max').textContent || 0;
  document.getElementById('totalScore').textContent = s1+s2+s3;
  document.getElementById('totalMax').textContent = m1+m2+m3;
}

/* ---------- Persistence ---------- */
function persistState(){
  const data = {
    name: document.getElementById('studentName').value,
    s1: Array.from(document.querySelectorAll('#s1Container .q')).map(q=> Array.from(q.querySelectorAll('.drop .tile')).map(t=>t.textContent)),
    s2: Array.from(document.querySelectorAll('.s2in')).map(i=>i.value),
    s3: Array.from(document.querySelectorAll('.s3in')).map(i=>i.value),
    scores: {
      s1:+document.getElementById('s1Score').textContent||0,
      s2:+document.getElementById('s2Score').textContent||0,
      s3:+document.getElementById('s3Score').textContent||0
    }
  };
  localStorage.setItem('siFutureWorksheet', JSON.stringify(data));
}

function restoreState(){
  const raw = localStorage.getItem('siFutureWorksheet');
  if(!raw) return;
  try{
    const data = JSON.parse(raw);
    document.getElementById('studentName').value = data.name||'';
    // Stage 1 restore
    const qs = document.querySelectorAll('#s1Container .q');
    if(data.s1 && data.s1.length === qs.length){
      data.s1.forEach((words, i)=>{
        const q = qs[i];
        const bank = q.querySelector('.chips');
        const drop = q.querySelector('.drop');
        // Move all tiles back to bank, then place in drop following saved order
        const allTiles = Array.from(q.querySelectorAll('.tile'));
        allTiles.forEach(t=>bank.appendChild(t));
        (words||[]).forEach(w=>{
          const tile = Array.from(bank.querySelectorAll('.tile')).find(t=>t.textContent===w);
          if(tile) drop.appendChild(tile);
        });
      });
    }
    // Stage 2 restore
    if(data.s2){
      document.querySelectorAll('.s2in').forEach((inp,i)=> inp.value = data.s2[i] || '');
    }
    // Stage 3 restore
    if(data.s3){
      document.querySelectorAll('.s3in').forEach((inp,i)=> inp.value = data.s3[i] || '');
    }
    // Restore scores
    if(data.scores){
      document.getElementById('s1Score').textContent = data.scores.s1||0;
      document.getElementById('s2Score').textContent = data.scores.s2||0;
      document.getElementById('s3Score').textContent = data.scores.s3||0;
      updateTotal();
    }
  }catch(e){console.warn('No restore', e);}
}

/* ---------- Reset ---------- */
function resetAll(){
  localStorage.removeItem('siFutureWorksheet');
  buildStage1(); buildStage2(); buildStage3();
  applyTeacherMode();
  document.getElementById('s1Score').textContent='0';
  document.getElementById('s2Score').textContent='0';
  document.getElementById('s3Score').textContent='0';
  updateTotal();
}

/* ---------- CSV Export ---------- */
function exportCSV(){
  const name = (document.getElementById('studentName').value||'').replace(/,/g,' ');
  const s1 = +document.getElementById('s1Score').textContent||0;
  const s2 = +document.getElementById('s2Score').textContent||0;
  const s3 = +document.getElementById('s3Score').textContent||0;
  const m1 = +document.getElementById('s1Max').textContent||0;
  const m2 = +document.getElementById('s2Max').textContent||0;
  const m3 = +document.getElementById('s3Max').textContent||0;
  const total = s1+s2+s3;
  const max = m1+m2+m3;
  const ts = new Date().toISOString();
  const lines = [
    "timestamp,name,stage1,stage1_max,stage2,stage2_max,stage3,stage3_max,total,total_max",
    [ts, name, s1, m1, s2, m2, s3, m3, total, max].join(",")
  ];
  const blob = new Blob([lines.join("\n")], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  a.download="si_future_results.csv";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{
    URL.revokeObjectURL(url);
    a.remove();
  }, 500);
}

/* ---------- Init ---------- */
buildStage1();
buildStage2();
buildStage3();
applyTeacherMode();
restoreState();

document.getElementById('checkAll').addEventListener('click', ()=>{ gradeStage(1); gradeStage(2); gradeStage(3); });
document.getElementById('resetAll').addEventListener('click', resetAll);
document.getElementById('exportCSV').addEventListener('click', exportCSV);
document.getElementById('studentName').addEventListener('input', persistState);
</script>
</body>
</html>
