<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reporteros 1 · Unidad 1 — Datos personales y profesiones · ProfeVT (v5 — tooltips)</title>
<style>:root{--bg:#f7fafc;--card:#ffffff;--ink:#0f172a;--muted:#475569;--accent:#0ea5e9;--accent2:#22c55e;--ok:#16a34a;--warn:#f59e0b}
*{box-sizing:border-box}html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;line-height:1.45}
header{padding:18px 16px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
header .brand{font-weight:900;letter-spacing:.5px;background:rgba(255,255,255,.15);padding:4px 10px;border-radius:999px}
header h1{margin:0;font-size:1.05rem}header p{margin:.25rem 0 0 0;opacity:.95}
.wrap{max-width:1140px;margin:20px auto;padding:0 12px}.card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.08);padding:14px;margin:14px 0}
.stage{border-left:6px solid var(--accent);padding-left:12px;margin-top:10px}.stage h2{margin:.2rem 0 .6rem;font-size:1.05rem}
.muted{color:var(--muted);font-size:.95rem}.q{margin:8px 0;padding:10px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;position:relative}
.q.correct{border-color:#86efac;background:#f0fdf4}.q.incorrect{border-color:#fecaca;background:#fff7f7}
.q .actions{display:flex;gap:8px;margin-top:6px}
.foot{display:flex;gap:10px;flex-wrap:wrap;align-items:center}.small{font-size:.85rem}
button{border:0;background:var(--accent);color:white;padding:8px 10px;border-radius:9px;cursor:pointer;font-weight:700}
button.ghost{background:#e2e8f0;color:#111827}.ok{background:var(--ok)}.warn{background:var(--warn)}
.chips{display:flex;flex-wrap:wrap;gap:6px;max-height:420px;overflow:auto;padding-right:4px}
.tile{padding:6px 8px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:8px;cursor:grab;user-select:none;font-size:.95rem;display:inline-flex;align-items:center;gap:6px}
.tile .ico{font-size:1rem}.tile.selected{outline:3px solid #0ea5e9;background:#e0f2fe}
.bin{min-height:32px;padding:4px 6px;border:2px dashed #cbd5e1;border-radius:10px;background:#f8fafc;margin:6px 0;display:flex;flex-wrap:wrap;gap:6px}
.bin.inline{display:inline-flex;vertical-align:baseline;margin:0 6px;min-width:16px;padding:3px 5px}
.key{display:none;margin-top:6px;font-size:.9rem;color:#2563eb}.score{font-weight:800}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-bottom-width:3px;padding:2px 6px;border-radius:6px}
input[type="text"]{padding:6px 8px;border-radius:8px;border:1px solid #cbd5e1;font-size:15px;vertical-align:baseline}
.inline-blank{display:inline-block;margin:0 .25rem}
.rule{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:10px;margin:8px 0}
.table{width:100%;border-collapse:collapse;margin:6px 0}.table th,.table td{border:1px solid #e2e8f0;padding:6px;border-radius:4px}
.grid2{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:860px){.grid2{grid-template-columns:1fr 1fr}}
.grid3{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:980px){.grid3{grid-template-columns:2fr 1fr}}
.grid4{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media(min-width:980px){.grid4{grid-template-columns:repeat(4,1fr)}}
.sticky{position:sticky; top:8px}hr{border:0;border-top:1px solid #e2e8f0;margin:8px 0}
.sa{display:grid;grid-template-columns:1fr repeat(4,90px);gap:8px;align-items:center}.sa label{display:flex;flex-direction:column;gap:6px;align-items:center;font-size:.9rem}.sa input{transform:scale(1.2)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#e0f2fe;border:1px solid #bae6fd;color:#0369a1;font-size:.8rem;margin-left:6px}
.emoji{font-size:32px;line-height:1}.sm{font-size:.9rem;color:#64748b}.aside{border-left:3px solid #e2e8f0;padding-left:10px}.aside h3{margin:.2rem 0 .4rem;font-size:.95rem}
.flag{font-size:1.05rem}
.hint{font-size:.9rem;color:#334155;background:#f8fafc;border:1px dashed #cbd5e1;padding:6px;border-radius:8px;margin-top:6px;display:none}
</style></head>
<body>
<header><span class="brand">ProfeVT</span><h1>Reporteros 1 · Unidad 1 — Datos personales y profesiones · ProfeVT (v5 — tooltips)</h1>
<p>Nombre: <input id="studentName" type="text" placeholder="Escribe tu nombre..." style="max-width:320px;margin-left:8px" /></p>
</header>
<div class="wrap">
  <div class="card"><h2>Lesson Goals</h2><ul><li>Identify common occupations from pictures.</li><li>Recognize and use personal information vocabulary.</li><li>Match basic questions with correct answers.</li><li>Read short biographies and complete a student ID.</li><li>Identify key information in short bios of famous Hispanic figures.</li></ul>
  <p class="muted">Add <span class="kbd">?teacher=1</span> to the URL to show keys. <em>Accents count.</em></p></div>
  
<div class="card stage" id="s0"><h2>0) Ocupaciones — empareja con la imagen</h2>
  <div class="q grid3">
    <div><div class="sm">Arrastra el nombre de la ocupación a cada imagen:</div><div class="grid4" id="s0Pics"></div></div>
    <div class="sticky"><div class="sm"><strong>Banco de palabras</strong> (clic y clic para colocar):</div><div class="chips" id="s0Bank"></div></div>
  </div>
  <div class="foot small"><button class="ok" onclick="gradeS0()">Calificar Etapa 0</button>
  <span>Puntaje: <span id="sc0" class="score">0</span> / <span id="mx0">0</span></span></div></div>

<div class="card stage" id="s1"><h2>1) Datos personales — empareja palabra con ejemplo</h2>
  <div class="q grid3"><div id="s1Pairs"></div>
  <div class="sticky"><div class="sm"><strong>Ejemplos</strong></div><div class="chips" id="s1Bank"></div></div></div>
  <div class="foot small"><button class="ok" onclick="gradeS1()">Calificar Etapa 1</button>
  <span>Puntaje: <span id="sc1" class="score">0</span> / <span id="mx1">0</span></span></div></div>

<div class="card stage" id="s2"><h2>2) Preguntas — empareja la pregunta con su respuesta</h2>
  <div class="q grid3"><div id="s2Pairs"></div>
  <div class="sticky"><div class="sm"><strong>Respuestas</strong></div><div class="chips" id="s2Bank"></div></div></div>
  <div class="foot small"><button class="ok" onclick="gradeS2()">Calificar Etapa 2</button>
  <span>Puntaje: <span id="sc2" class="score">0</span> / <span id="mx2">0</span></span></div></div>

<div class="card stage" id="s3"><h2>3) Clasifica — ¿Pregunta o respuesta?</h2>
  <div class="q"><div class="grid2"><div><strong>Preguntas</strong><div class="bin" id="s3Q"></div></div>
  <div><strong>Respuestas</strong><div class="bin" id="s3A"></div></div></div><hr><div class="chips" id="s3Bank"></div></div>
  <div class="foot small"><button class="ok" onclick="gradeS3()">Calificar Etapa 3</button>
  <span>Puntaje: <span id="sc3" class="score">0</span> / <span id="mx3">0</span></span></div></div>

<div class="card stage" id="s4"><h2>4) Read the biography and complete the ID card (full sentences in Spanish)</h2>
  <div class="rule small">Write complete sentences in Spanish, including numbers spelled out (e.g., <em>quince</em>, <em>catorce de febrero</em>). If your answer is incorrect, a model sentence appears so you can correct it on the next attempt.</div>
  <div id="s4Container"></div>
  <div class="foot small"><button class="ok" onclick="gradeS4()">Calificar Etapa 4</button>
  <span>Puntaje: <span id="sc4" class="score">0</span> / <span id="mx4">0</span></span></div></div>

<div class="card stage" id="s5"><h2>5) Biografías famosas — identifica país y ocupación</h2>
  <div class="q grid3"><div><div id="s5Container"></div><div class="key" id="s5Key"></div></div>
  <aside class="sticky aside"><h3>Word bank</h3>
    <div class="sm">Countries</div><div class="chips" id="s5BankCountries"></div>
    <div class="sm" style="margin-top:8px">Occupations</div><div class="chips" id="s5BankJobs"></div>
  </aside></div>
  <div class="foot small"><button class="ok" onclick="gradeS5()">Calificar Etapa 5</button>
  <span>Puntaje: <span id="sc5" class="score">0</span> / <span id="mx5">0</span></span></div></div>

<div class="card stage" id="selfAssess"><h2>Self-Assessment — How confident are you with the goals?</h2>
  <div class="rule small">Rate 1–4: 1 <em>Beginning</em>, 2 <em>Approaching</em>, 3 <em>Meeting</em>, 4 <em>Exceeding</em>.</div>
  <div class="q">
    <div class="sa"><div>1) Identify common occupations from pictures.</div>
      <label>1<br><input type="radio" name="sa1" value="1"></label><label>2<br><input type="radio" name="sa1" value="2"></label><label>3<br><input type="radio" name="sa1" value="3"></label><label>4<br><input type="radio" name="sa1" value="4"></label></div>
    <div class="sa"><div>2) Recognize and use personal information vocabulary.</div>
      <label>1<br><input type="radio" name="sa2" value="1"></label><label>2<br><input type="radio" name="sa2" value="2"></label><label>3<br><input type="radio" name="sa2" value="3"></label><label>4<br><input type="radio" name="sa2" value="4"></label></div>
    <div class="sa"><div>3) Match basic questions with correct answers.</div>
      <label>1<br><input type="radio" name="sa3" value="1"></label><label>2<br><input type="radio" name="sa3" value="2"></label><label>3<br><input type="radio" name="sa3" value="3"></label><label>4<br><input type="radio" name="sa3" value="4"></label></div>
    <div class="sa"><div>4) Read short biographies and complete a student ID.</div>
      <label>1<br><input type="radio" name="sa4" value="1"></label><label>2<br><input type="radio" name="sa4" value="2"></label><label>3<br><input type="radio" name="sa4" value="3"></label><label>4<br><input type="radio" name="sa4" value="4"></label></div>
    <div class="sa"><div>5) Identify key information in short bios of famous Hispanic figures.</div>
      <label>1<br><input type="radio" name="sa5" value="1"></label><label>2<br><input type="radio" name="sa5" value="2"></label><label>3<br><input type="radio" name="sa5" value="3"></label><label>4<br><input type="radio" name="sa5" value="4"></label></div>
  </div></div>

  <div class="card foot small"><button id="checkAll" class="ok">Grade all</button>
  <button id="resetAll" class="ghost">Reset page</button>
  <button id="exportCSV" class="warn">Download results (.csv)</button>
  <span>Total: <span id="totalScore" class="score">0</span> / <span id="totalMax">0</span></span></div>
</div>
<script>
const teacherMode = new URLSearchParams(location.search).get('teacher')==='1';
function shuffle(a){a=a.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function cmpExact(a,b){ return (a||'').trim().toLowerCase() === (b||'').trim().toLowerCase(); }
function applyTeacher(){ if(teacherMode){ document.querySelectorAll('.key').forEach(k=>k.style.display='block'); } }
let selectedTile = null;
function makeTileInteractive(tile){
  tile.addEventListener('dragstart', ()=>{ selectedTile = tile; tile.classList.add('selected'); });
  tile.addEventListener('click', ()=>{
    if(selectedTile && selectedTile!==tile){ selectedTile.classList.remove('selected'); }
    if(tile.classList.contains('selected')){ tile.classList.remove('selected'); selectedTile=null; }
    else { tile.classList.add('selected'); selectedTile = tile; }
  });
}
function makeBinInteractive(bin){
  bin.addEventListener('dragover', e=>e.preventDefault());
  bin.addEventListener('drop', e=>{ e.preventDefault(); if(selectedTile){ bin.appendChild(selectedTile); selectedTile.classList.remove('selected'); selectedTile=null; }});
  bin.addEventListener('click', ()=>{ if(selectedTile){ bin.appendChild(selectedTile); selectedTile.classList.remove('selected'); selectedTile=null; }});
}
function exportCSVGeneric(filename, headers, row){
  const ts=new Date().toISOString();
  const name=(document.querySelector('#studentName').value||'').replace(/,/g,' ');
  const blob=new Blob([headers+"\n"+[ts,name].concat(row).join(',')],{type:"text/csv"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},500);
}
function moveAllTiles(fromEl, toEl){ Array.from(fromEl.querySelectorAll('.tile')).forEach(t=>toEl.appendChild(t)); }
function buildResetBtn(label, onClick){ const b=document.createElement('button'); b.className='ghost'; b.textContent=label; b.addEventListener('click', onClick); return b; }

const OCCUPATIONS = [["actor/actriz", "🎭", "actor/actress"], ["astronauta", "🧑‍🚀", "astronaut"], ["cantante", "🎤", "singer"], ["cocinero/cocinera", "👨‍🍳", "cook/chef"], ["deportista", "🏅", "athlete"], ["director/directora", "🎬", "director"], ["doctor/doctora", "🩺", "doctor"], ["escritor/escritora", "✍️", "writer"], ["estudiante", "🎒", "student"], ["fotógrafo/fotógrafa", "📸", "photographer"], ["juez/jueza", "⚖️", "judge"], ["periodista", "📰", "journalist"], ["profesor/profesora", "👩‍🏫", "teacher"]];
const DATOS_MATCH = [["nombre", "Lucía García", "full name"], ["edad", "15 años", "age: 15 years"], ["país", "México", "country: Mexico"], ["ocupación", "estudiante", "occupation: student"], ["correo electrónico", "lucia@gmail.com", "email"], ["número de teléfono", "555-123-4567", "phone number"], ["cumpleaños", "14 de febrero", "birthday (Feb 14)"]];
const QA_PAIRS = [["¿Cómo te llamas?", "Me llamo Ana.", "What's your name? → My name is Ana."], ["¿Cuántos años tienes?", "Tengo 14 años.", "How old are you? → I'm 14 years old."], ["¿Cuándo es tu cumpleaños?", "Es el 14 de febrero.", "When is your birthday? → It's Feb 14."], ["¿De dónde eres?", "Soy de Guatemala.", "Where are you from? → I'm from Guatemala."], ["¿Cuál es tu correo electrónico?", "ana@gmail.com", "What's your email?"], ["¿Cuál es tu número de teléfono?", "555-789-3210", "What's your phone number?"]];
const SORT_ITEMS = ["¿Cómo te llamas?", "Me llamo Diego.", "¿De dónde eres?", "Soy de Perú.", "¿Cuál es tu número de teléfono?", "Es 555-333-1111.", "Tengo 13 años.", "¿Cuántos años tienes?"];
const BIOS = [{"text": "Hola, me llamo Sofía. Tengo 13 años. Soy de Argentina. Mi cumpleaños es el 12 de junio. Soy estudiante y me gusta el arte.", "sol": {"nombre": "Sofía", "edad": "13", "país": "Argentina", "cumpleaños": "12 de junio", "ocupación": "estudiante"}}, {"text": "Me llamo Mateo. Tengo 15 años y soy de México. Mi cumpleaños es el 3 de abril. Soy estudiante y me gusta el béisbol.", "sol": {"nombre": "Mateo", "edad": "15", "país": "México", "cumpleaños": "3 de abril", "ocupación": "estudiante"}}];
const COUNTRY_FLAGS = {"Estados Unidos": "🇺🇸", "México": "🇲🇽", "Chile": "🇨🇱", "España": "🇪🇸", "Argentina": "🇦🇷", "Guatemala": "🇬🇹"};
const COUNTRY_EN = {"Estados Unidos": "United States", "México": "Mexico", "Chile": "Chile", "España": "Spain", "Argentina": "Argentina", "Guatemala": "Guatemala"};
const JOB_ICONS = {"líder laboral": "✊", "poeta": "✍️", "pintora": "🎨", "cantante": "🎤", "astronauta": "🚀", "jueza": "⚖️", "juez": "⚖️"};
const JOB_EN = {"líder laboral": "labor leader / organizer", "poeta": "poet", "pintora": "painter", "cantante": "singer", "astronauta": "astronaut", "jueza": "judge", "juez": "judge"};
const FAMOUS = [["César Chávez", {"país": "Estados Unidos", "ocupación": "líder laboral"}, "Fue un líder laboral y activista de los derechos civiles. Organizó a trabajadores agrícolas para mejorar sus condiciones."], ["Dolores Huerta", {"país": "Estados Unidos", "ocupación": "líder laboral"}, "Cofundadora de la UFW, impulsó el lema «¡Sí se puede!» y luchó por los derechos de los trabajadores del campo."], ["Pablo Neruda", {"país": "Chile", "ocupación": "poeta"}, "Poeta chileno, ganador del Premio Nobel de Literatura, conocido por sus odas y poemas de amor."], ["Frida Kahlo", {"país": "México", "ocupación": "pintora"}, "Pintora mexicana famosa por sus autorretratos que exploran identidad, dolor y cultura."], ["Rosalía", {"país": "España", "ocupación": "cantante"}, "Cantante española que fusiona flamenco con pop y otros géneros contemporáneos."], ["Ellen Ochoa", {"país": "Estados Unidos", "ocupación": "astronauta"}, "Ingeniera y astronauta; la primera mujer hispana en viajar al espacio."], ["Sonia Sotomayor", {"país": "Estados Unidos", "ocupación": "jueza"}, "Jueza de la Corte Suprema de Estados Unidos y primera hispana en ese cargo."]];

// Stage 0
function buildS0(){
  const pics=document.getElementById('s0Pics'); pics.innerHTML='';
  const bank=document.getElementById('s0Bank'); bank.innerHTML='';
  document.getElementById('mx0').textContent = OCCUPATIONS.length;
  OCCUPATIONS.forEach(([esp,icon,en],i)=>{
    const card=document.createElement('div'); card.className='q';
    const cont=document.createElement('div');
    cont.innerHTML = '<span class="emoji">'+icon+'</span> Coloca: ';
    const bin=document.createElement('div'); bin.className='bin inline'; bin.id='s0b'+i; makeBinInteractive(bin);
    cont.appendChild(bin);
    card.appendChild(cont);
    const actions=document.createElement('div'); actions.className='actions';
    actions.appendChild(buildResetBtn('Reset', ()=>{ moveAllTiles(bin, bank); }));
    card.appendChild(actions);
    pics.appendChild(card);
  });
  OCCUPATIONS.forEach(([txt,_,en])=>{
    const t=document.createElement('span'); t.className='tile'; t.textContent=txt; t.setAttribute('data-val',txt); t.title=en;
    t.draggable=true; makeTileInteractive(t); bank.appendChild(t);
  });
}
function gradeS0(){
  let score=0;
  OCCUPATIONS.forEach(([esp,_],i)=>{
    const bin=document.getElementById('s0b'+i);
    const chosen=bin.querySelector('.tile')?.getAttribute('data-val')||'';
    if(cmpExact(chosen, esp)) score++;
  });
  document.getElementById('sc0').textContent=score; updateTotal();
}

// Stage 1
function buildS1(){
  const pairs=document.getElementById('s1Pairs'); pairs.innerHTML='';
  const bank=document.getElementById('s1Bank'); bank.innerHTML='';
  document.getElementById('mx1').textContent = DATOS_MATCH.length;
  DATOS_MATCH.forEach(([term,example,en],i)=>{
    const row=document.createElement('div'); row.className='q';
    const span=document.createElement('span'); span.innerHTML = '<strong>'+(i+1)+'.</strong> '+term+' → ';
    const bin=document.createElement('div'); bin.className='bin inline'; bin.id='s1b'+i; makeBinInteractive(bin);
    span.appendChild(bin);
    row.appendChild(span);
    const key=document.createElement('div'); key.className='key'; key.textContent='Model: '+example; row.appendChild(key);
    const actions=document.createElement('div'); actions.className='actions';
    actions.appendChild(buildResetBtn('Reset', ()=>{ moveAllTiles(bin, bank); }));
    row.appendChild(actions);
    pairs.appendChild(row);
  });
  DATOS_MATCH.forEach(([_,ex,en])=>{
    const t=document.createElement('span'); t.className='tile'; t.textContent=ex; t.setAttribute('data-val',ex); t.title=en;
    t.draggable=true; makeTileInteractive(t); bank.appendChild(t);
  });
}
function gradeS1(){
  let score=0;
  DATOS_MATCH.forEach(([,example],i)=>{
    const bin=document.getElementById('s1b'+i);
    const chosen=bin.querySelector('.tile')?.getAttribute('data-val')||'';
    if(cmpExact(chosen, example)) score++;
  });
  document.getElementById('sc1').textContent=score; updateTotal();
}

// Stage 2
function buildS2(){
  const pairs=document.getElementById('s2Pairs'); pairs.innerHTML='';
  const bank=document.getElementById('s2Bank'); bank.innerHTML='';
  document.getElementById('mx2').textContent = QA_PAIRS.length;
  QA_PAIRS.forEach(([q,a,en],i)=>{
    const row=document.createElement('div'); row.className='q';
    const span=document.createElement('span'); span.innerHTML = '<strong>'+(i+1)+'.</strong> '+q+' → ';
    const bin=document.createElement('div'); bin.className='bin inline'; bin.id='s2b'+i; makeBinInteractive(bin);
    span.appendChild(bin);
    row.appendChild(span);
    const key=document.createElement('div'); key.className='key'; key.textContent='Model: '+a; row.appendChild(key);
    const actions=document.createElement('div'); actions.className='actions';
    actions.appendChild(buildResetBtn('Reset', ()=>{ moveAllTiles(bin, bank); }));
    row.appendChild(actions);
    pairs.appendChild(row);
  });
  QA_PAIRS.forEach(([_,ans,en])=>{
    const t=document.createElement('span'); t.className='tile'; t.textContent=ans; t.setAttribute('data-val',ans); t.title=en;
    t.draggable=true; makeTileInteractive(t); bank.appendChild(t);
  });
}
function gradeS2(){
  let score=0;
  QA_PAIRS.forEach(([,a],i)=>{
    const bin=document.getElementById('s2b'+i);
    const chosen=bin.querySelector('.tile')?.getAttribute('data-val')||'';
    if(cmpExact(chosen, a)) score++;
  });
  document.getElementById('sc2').textContent=score; updateTotal();
}

// Stage 3
function isQuestionText(s){ return s.trim().startsWith('¿') && s.trim().endsWith('?'); }
function buildS3(){
  ['s3Q','s3A'].forEach(id=>makeBinInteractive(document.getElementById(id)));
  const bank=document.getElementById('s3Bank'); bank.innerHTML='';
  document.getElementById('mx3').textContent = SORT_ITEMS.length;
  shuffle(SORT_ITEMS).forEach(txt=>{
    const t=document.createElement('span'); t.className='tile'; t.textContent=txt; t.draggable=true; makeTileInteractive(t); 
    t.title = isQuestionText(txt) ? 'question' : 'answer';
    bank.appendChild(t);
  });
  const actions=document.createElement('div'); actions.className='actions';
  actions.appendChild(buildResetBtn('Reset Preguntas', ()=>{ moveAllTiles(document.getElementById('s3Q'), bank); }));
  actions.appendChild(buildResetBtn('Reset Respuestas', ()=>{ moveAllTiles(document.getElementById('s3A'), bank); }));
  document.querySelector('#s3 .q').appendChild(actions);
}
function gradeS3(){
  let score=0;
  document.querySelectorAll('#s3Q .tile').forEach(t=>{ if(isQuestionText(t.textContent)) score++; });
  document.querySelectorAll('#s3A .tile').forEach(t=>{ if(!isQuestionText(t.textContent)) score++; });
  document.getElementById('sc3').textContent = score; updateTotal();
}

// Stage 4
function buildS4(){
  const c=document.getElementById('s4Container'); c.innerHTML='';
  document.getElementById('mx4').textContent = BIOS.length*5;
  BIOS.forEach((bio,idx)=>{
    const card=document.createElement('div'); card.className='q';
    const p=document.createElement('p'); p.textContent = bio.text; card.appendChild(p);
    const fields=[
      ['nombre','Write: Su nombre es ___.', 'Su nombre es '+bio.sol['nombre']+'.'],
      ['edad','Write: Tiene ___ años.', 'Tiene '+bio.sol['edad']+' años.'],
      ['país','Write: Es de ___.', 'Es de '+bio.sol['país']+'.'],
      ['cumpleaños','Write: Su cumpleaños es el ___.', 'Su cumpleaños es el '+bio.sol['cumpleaños']+'.'],
      ['ocupación','Write: Es ___.', 'Es '+bio.sol['ocupación']+'.']
    ];
    const tbl=document.createElement('table'); tbl.className='table';
    tbl.innerHTML='<tr><th>Field</th><th>Your sentence</th></tr>';
    fields.forEach(([k,prompt,model],j)=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td'); td1.textContent=k; tr.appendChild(td1);
      const td2=document.createElement('td');
      td2.appendChild(document.createTextNode(prompt+' '));
      const inp=document.createElement('input'); inp.type='text'; inp.className='s4in'; inp.setAttribute('data-ans',model.toLowerCase());
      inp.size=Math.max(10, model.length+2);
      td2.appendChild(inp);
      const hint=document.createElement('div'); hint.className='hint'; hint.id='s4hint_'+idx+'_'+j; hint.textContent='Model: '+model;
      td2.appendChild(hint);
      tr.appendChild(td2);
      tbl.appendChild(tr);
    });
    card.appendChild(tbl);
    const actions=document.createElement('div'); actions.className='actions';
    actions.appendChild(buildResetBtn('Reset', ()=>{ card.querySelectorAll('.s4in').forEach(i=>i.value=''); card.querySelectorAll('.hint').forEach(h=>h.style.display='none'); card.classList.remove('correct','incorrect'); }));
    card.appendChild(actions);
    c.appendChild(card);
  });
}
function gradeS4(){
  let score=0, idx=0;
  document.querySelectorAll('#s4Container .q').forEach(card=>{
    let local=0, j=0;
    card.querySelectorAll('.s4in').forEach(inp=>{
      const correct=inp.getAttribute('data-ans');
      if(cmpExact(inp.value, correct)) local++; else { const h=card.querySelector('#s4hint_'+idx+'_'+j); if(h) h.style.display='block'; }
      j++;
    });
    score+=local;
    if(local===5) card.classList.add('correct'); else card.classList.add('incorrect');
    idx++;
  });
  document.getElementById('sc4').textContent = score; updateTotal();
}

// Stage 5
function countNeeded(arr, keyGetter){ const counts={}; arr.forEach(x=>{ const k=keyGetter(x); counts[k]=(counts[k]||0)+1; }); return counts; }
function buildS5(){
  const c=document.getElementById('s5Container'); c.innerHTML='';
  document.getElementById('mx5').textContent = FAMOUS.length*2;
  FAMOUS.forEach(([name,data,bio],i)=>{
    const row=document.createElement('div'); row.className='q';
    const title=document.createElement('div'); title.innerHTML='<strong>'+(i+1)+'. '+name+'</strong>';
    const narrative=document.createElement('p'); narrative.className='sm'; narrative.textContent=bio;
    const tbl=document.createElement('table'); tbl.className='table';
    tbl.innerHTML='<tr><th>Field</th><th>Drop here</th></tr>'
      +'<tr><td>país</td><td><div class="bin inline" id="f_p_'+i+'"></div></td></tr>'
      +'<tr><td>ocupación</td><td><div class="bin inline" id="f_o_'+i+'"></div></td></tr>';
    row.appendChild(title); row.appendChild(narrative); row.appendChild(tbl);
    const key=document.createElement('div'); key.className='key'; key.textContent='Model: '+data.país+' / '+data.ocupación; row.appendChild(key);
    const actions=document.createElement('div'); actions.className='actions';
    actions.appendChild(buildResetBtn('Reset', ()=>{
      moveAllTiles(document.getElementById('f_p_'+i), document.getElementById('s5BankCountries'));
      moveAllTiles(document.getElementById('f_o_'+i), document.getElementById('s5BankJobs'));
      row.classList.remove('correct','incorrect');
    }));
    row.appendChild(actions);
    c.appendChild(row);
    makeBinInteractive(document.getElementById('f_p_'+i));
    makeBinInteractive(document.getElementById('f_o_'+i));
  });
  const bc=document.getElementById('s5BankCountries'); bc.innerHTML='';
  const bj=document.getElementById('s5BankJobs'); bj.innerHTML='';
  const needCountries = countNeeded(FAMOUS, x=>x[1].país);
  const needJobs = countNeeded(FAMOUS, x=>x[1].ocupación);
  Object.keys(needCountries).forEach(country=>{
    const n=needCountries[country];
    for(let i=0;i<n;i++){
      const t=document.createElement('span'); t.className='tile'; t.setAttribute('data-val',country);
      t.title = COUNTRY_EN[country] || country;
      t.innerHTML='<span class="ico flag">'+(COUNTRY_FLAGS[country]||'')+'</span><span>'+country+'</span>'; t.draggable=true; makeTileInteractive(t); bc.appendChild(t);
    }
  });
  Object.keys(needJobs).forEach(job=>{
    const n=needJobs[job];
    for(let i=0;i<n;i++){
      const t=document.createElement('span'); t.className='tile'; t.setAttribute('data-val',job);
      t.title = JOB_EN[job] || job;
      t.innerHTML='<span class="ico">'+(JOB_ICONS[job]||'🧑‍💼')+'</span><span>'+job+'</span>'; t.draggable=true; makeTileInteractive(t); bj.appendChild(t);
    }
  });
  document.getElementById('s5Key').textContent='Drag one correct country and one correct occupation for each person.';
}
function gradeS5(){
  let score=0;
  FAMOUS.forEach(([_,data],i)=>{
    const p=document.querySelector('#f_p_'+i+' .tile')?.getAttribute('data-val')||'';
    const o=document.querySelector('#f_o_'+i+' .tile')?.getAttribute('data-val')||'';
    let local=0; if(cmpExact(p,data.país)) local++; if(cmpExact(o,data.ocupación)) local++;
    score+=local;
    const row=document.querySelectorAll('#s5Container .q')[i];
    if(local===2) row.classList.add('correct'); else row.classList.add('incorrect');
  });
  document.getElementById('sc5').textContent=score; updateTotal();
}

// Totals + CSV + Init
function updateTotal(){
  const ids=[0,1,2,3,4,5];
  const scores=ids.map(i=>+document.getElementById('sc'+i).textContent||0);
  const maxes =ids.map(i=>+document.getElementById('mx'+i).textContent||0);
  document.getElementById('totalScore').textContent=scores.reduce((a,b)=>a+b,0);
  document.getElementById('totalMax').textContent=maxes.reduce((a,b)=>a+b,0);
}
function radioVal(name){ const el=document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:''; }
function exportCSV(){
  const ids=[0,1,2,3,4,5];
  const row=[]; ids.forEach(i=>{ row.push(+document.getElementById('sc'+i).textContent||0); row.push(+document.getElementById('mx'+i).textContent||0); });
  const sa1=radioVal('sa1'), sa2=radioVal('sa2'), sa3=radioVal('sa3'), sa4=radioVal('sa4'), sa5=radioVal('sa5');
  const total=row.filter((_,i)=>i%2===0).reduce((a,b)=>a+b,0);
  const totalMax=row.filter((_,i)=>i%2===1).reduce((a,b)=>a+b,0);
  exportCSVGeneric('R1_U1_datos_personales_results_v5.csv','timestamp,name,s0,s0_max,s1,s1_max,s2,s2_max,s3,s3_max,s4,s4_max,s5,s5_max,total,total_max,sa1,sa2,sa3,sa4,sa5',[...row,total,totalMax,sa1,sa2,sa3,sa4,sa5]);
}
function init(){
  buildS0(); buildS1(); buildS2(); buildS3(); buildS4(); buildS5(); applyTeacher();
  document.getElementById('checkAll').addEventListener('click', ()=>{ gradeS0(); gradeS1(); gradeS2(); gradeS3(); gradeS4(); gradeS5(); });
  document.getElementById('resetAll').addEventListener('click', ()=>{ location.reload(); });
  document.getElementById('exportCSV').addEventListener('click', exportCSV);
}
init();
</script>
</body></html>